window.repositoryObject = {"parameters_custom_fields":[],"object_id":"p251","name":"usp_GetDATLoadLead","subtype":"PROCEDURE","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"LoadMatching@UDVLPLL4DATASRV.linklogi.com","id":"d9"}},{"field":"Schema","value":"dbo"},{"field":"Name","value":"usp_GetDATLoadLead"},{"field":"Type","value":"Procedure"}],"script":"CREATE PROCEDURE [dbo].[usp_GetDATLoadLead] \r\n  --@UserID           int         \r\n  @CustCD\t\t\tvarchar(10)\r\n ,@LToken           int = 0\r\n ,@ServerName       Varchar(75) = '' \r\n ,@Version          Varchar(50) = 'V4.00'\r\n ,@MileageProvider  CHAR(1) = 'P' -- G=Google (Default), P=PCMiler \r\n ,@LeadFrom         datetime2 = NULL\r\n ,@LeadsCap\t\t\tINT = 0\r\n\r\n\r\n--------------------------------------------------------------------------\r\n--PROCEDURE NAME : usp_GetDATLoadLead\r\n--------------------------------------------------------------------------\r\n-- DESCRIPTION    : Get DAT Load Lead for the Users\r\n--\r\n-- CALLED BY      : LoadMatching Web API \r\n-- EXECUTION FREQUENCY : \r\n-- \r\n-- INPUT PARAMS   : @CustCD             - Caller CustCD\r\n--                  @LToken             - Load Token is pass if retrieving the Lead for 1 Load Posting         \r\n--                  @ServerName         - Name of Web Server where the request is coming from \r\n--                  @Version            - Version of calling Client\r\n--                  @MileageProvider    - Mileage Engine Provider, G=Google(Default), P=PCMiler\r\n--                  @LeadFrom           - If null, then return all avilable lead, otherwise return any lead newer than @LeadFrom \r\n--\t\t\t\t\t@LeadsCap\t\t\t- Optional. if 0 return ALL Leads, and if >0 = Cap leads to this value.\r\n--                 \r\n-- OUTPUT PARAMS  :\r\n-- STATUS RETURN  : \r\n-------------------------------------------------------------------------------------------------------------------------------------------------\r\n-- HISTORY : \r\n-- AUTHOR    DATE           DESCRIPTION\r\n-- Hiro      2018.09.07     Initial Development\r\n-- Hiro      2018.10.30     LiveLead mode (@LeadFrom <> null) only return Secondary Match (LLSIM-1604)\r\n-- Nesrin    2019.03.08\t    LLSIM-1758: Change the Default value of @MileageProvider to P to get the PCMilerMiles\r\n-- Tharun    2019.04.02\t\tLLSIM-2503: As DAT lead - Contacted does not remain green when selecting a different screen.\r\n-- Nesrin    2019.05.21     LLSIM-2718: Update the stored procedure to retrieve the missing values for DAT customers (Phone & Email)\r\n-- Nesrin    2019.06.13     LLSIM-2884: Fix Live Leads to get the Leads posted within the provided time stamp range\r\n--                          For the live leads, the query was checking the CreatedOn value of DATLoadLeads (Matching date) and not the value in \r\n--                          DATEquipmentPosting (actual date the posted is created)\r\n-- Vevian    2019.06.26     LLSIM-2958: for Live DAT Leads, only return up to 150 leads +\r\n--\t\t\t\t\t\t\tSort the returned leads (all leads)  \r\n-- Vevian    2019.06.27     LLSIM-2962: change @UserID parameter to @CustCD since CustCD is needed for the logic here not UserID\r\n--\t\t\t\t\t\t\t\t\t\tNo need to use (dbo.udf_GetCustCd) function anymore in this case\r\n--\t\t\t\t\t\t\t\t\t\t+ return new value posting Type (PType) - 'L' for Load & 'E' for Equipment\r\n-- Vevian\t 2019.07.03\t\tLLSIM-2989: Return the proper contacted value (fix conditions in the Left Join with Contacted table)\r\n-- Nesrin    2019.11.18     LLSIM-3633: Update the SP usp_GetDATLoadLead to return 0 value for the Customer Tracking\r\n-- Nesrin   2020.02.27      LLSIM-3974: SP code changes \r\n-- Vevian   2020.02.27      Performance issue for LLW4 (Add nolock, drop temp table, Add leads capping)\r\n-- John\t\t2020.03.09\t\tLLSIM-4001 - optimization and refactor\r\n-- Vevian\t2020.03.23\t\tLLSIM-4046: add optional parameter \"LeadsCap\"\r\n--\t\t\t\t\t\t\t\t\t\t0 = ALL Leads, >0 = Cap leads to this value.\r\n-------------------------------------------------------------------------------------------------------------------------------------------------\r\nAS\r\n\r\nBEGIN\r\n\r\n\tSET NOCOUNT ON\r\n\t\r\n\t--DECLARE @CustCD Varchar(10) = ''\r\n\tDECLARE @LiveCall BIT = 1 -- 1=Live , 0=Non-Live\r\n\tDECLARE @defaultDisplayCount AS INT = 150\r\n\r\n\t---- Get the CustCd from Account Table for Now \r\n\t--SELECT @CustCD = dbo.udf_GetCustCd (@UserId)\r\n\r\n\tIF (@LeadFrom IS NULL)\r\n\t\tBEGIN\r\n\t\t\t-- since we are not getting values from a table, it is more efficient to use SET\r\n\t\t\tSET @LeadFrom = '1997-01-01 00:00:00:000'\r\n\t\t\tSET @LiveCall = 0\t\r\n\t\t\t--SET @defaultDisplayCount = 0 -- 0 show all rows\r\n\t\t\tSET @defaultDisplayCount = @LeadsCap\t-- default 0 to show all rows\r\n\t\tEND\t\r\n \r\n\tSET ROWCOUNT @defaultDisplayCount -- set total number of rows to return\r\n\r\n\tSELECT \r\n\t\tE.CustCD ,\r\n\t\tE.DateAvail ,\r\n\r\n\t\tE.SrceID ,\r\n\t\tE.SrceCity ,\r\n\t\tE.SrceSt ,\r\n\t\tE.SrceCountry ,\r\n\t\tE.SrceLong ,\r\n\t\tE.SrceLat ,\r\n\r\n\t\tE.DestID ,\r\n\t\tE.DestCity ,\r\n\t\tE.DestSt ,\r\n\t\tE.DestCountry ,\r\n\t\tE.DestLong ,\r\n\t\tE.DestLat ,\r\n\r\n\t\tvs.Code VehicleSize, -- eliminate function call to avoid repeated table scans\r\n\t\tdbo.udf_VTypeToString(E.VType) VehicleType ,\r\n\t\tE.Comment ,\r\n\t\t'A' PostMode ,\r\n\t\t'' ClientRefNum ,\r\n\t\t'' ProductName ,\r\n\t\t'' PostingAttrib ,\r\n\t\tdbo.udf_GetMileage(E.SrceID,E.DestID,@MileageProvider) Distance,\r\n\t\tL.Token      LToken ,\r\n\t\tE.Token      EToken ,\r\n\t\tE.CreatedBy ,\r\n\t\tE.CreatedOn ,\r\n\t\tE.DeletedBy ,\r\n\t\tE.DeletedOn ,\r\n\t\t-- Here are the list of hardcoded field until requirement is finilized.\r\n\t\tISNULL(A.XMT_NAME,'NA') Company ,\r\n\t\tISNULL(A.XMT_PHONE,'NA') Phone,\r\n\t\tISNULL(A.EMAIL_ADDRESS,'NA') Email,\r\n\t\t0 QPStatus ,\r\n\t\t-1 Equifax ,     \r\n\t\t-1 TCC ,\r\n\t\tCONVERT(INT, ISNULL(Idx.Analysis,-1)) TCUS ,\r\n\t\tdbo.udf_DestDirection (L.SrceLong,L.SrceLat, E.SrceLong,E.SrceLat) DirO ,\r\n\t\tdbo.udf_GetMileage(E.SrceID, L.SrceID, @MileageProvider) DFO ,\r\n\t\tdbo.udf_GetMileage(E.DestID, L.DestID, @MileageProvider) DFD,\r\n\t\tIIF(Cn.LToken IS NULL,'', 'Y') Contacted, -- since we only have one case, it is more syntatically and cleaner to use IIF vs CASE\r\n\t\tIIF(F.ContactCustCd IS NULL, 0, F.Id) Flag,\r\n\t\t'DAT' SubscriberType,\r\n\t\t'E' PType,\r\n\t\t0 CustomerTracking\r\n\tFROM dbo.DATLoadLead LL\t(NOLOCK)\r\n\t\tINNER JOIN dbo.LoadPosting L (NOLOCK) ON LL.LToken=L.Token\r\n\t\tINNER JOIN dbo.DATEquipmentPosting E (NOLOCK) ON LL.EToken=E.Token\r\n\t\tLEFT JOIN dbo.VehicleSize vs ON E.VSize = vs.[Value] AND vs.PostType = 'E'\r\n\t\tLEFT JOIN  dbo.DatCustomer A (NOLOCK) ON A.CustCD = E.CustCd\r\n\t\tLEFT JOIN  dbo.Contacted Cn (NOLOCK) ON (Cn.LToken = 0 AND Cn.EToken = LL.EToken AND Cn.CustCd = L.CustCd AND Cn.CnCustCd = E.CustCd)\r\n\t\tLEFT JOIN  dbo.Flag F (NOLOCK) ON (F.EToken = LL.EToken AND F.LToken = LL.LToken AND F.CustCd = L.CustCd AND F.ContactCustCd = E.CustCd)\r\n\t\t-- Once Account information is accessible Contacted and Finance Index will be returned\r\n\t\tLEFT JOIN Finance.dbo.TransCredit  Idx (NOLOCK) on Idx.CustCD = A.Account_ID \r\n\tWHERE L.CustCd = @CustCd\r\n\t\tAND (@LToken = 0 OR @LToken = L.Token)\r\n\t\tAND (E.DeletedOn IS NULL)\r\n\t\tAND (L.DeletedOn IS NULL)\r\n\t\tAND (E.CreatedOn > @LeadFrom)\r\n\t\tAND (NOT EXISTS ( SELECT 1 FROM Exclude x (NOLOCK) WHERE x.CustCd = @CustCd  AND x.ExcludeCustCd = e.CustCd) ) \r\n\t\tAND (NOT EXISTS ( SELECT 1 FROM Exclude x (NOLOCK) WHERE x.CustCd = e.CustCd AND x.ExcludeCustCd = @CustCd ) ) \r\n\t\tAND (@LiveCall = 0 OR LL.LeadType = 'S') -- In LiveLead only return the secondary match lead.\r\n\tORDER BY CreatedOn DESC\r\n\r\n\tSET ROWCOUNT 0 -- reset\r\n \r\nEND","parameters":[{"name":"CustCD","description":null,"mode":"IN","data_type":"varchar(10)","custom_fields":{}},{"name":"LToken","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"ServerName","description":null,"mode":"IN","data_type":"varchar(75)","custom_fields":{}},{"name":"Version","description":null,"mode":"IN","data_type":"varchar(50)","custom_fields":{}},{"name":"MileageProvider","description":null,"mode":"IN","data_type":"char(1)","custom_fields":{}},{"name":"LeadFrom","description":null,"mode":"IN","data_type":"datetime2(7)","custom_fields":{}},{"name":"LeadsCap","description":null,"mode":"IN","data_type":"int","custom_fields":{}}],"dependencies":null,"imported_at":"2021-07-29 12:59"};