window.repositoryObject = {"parameters_custom_fields":[],"object_id":"p276","name":"usp_GetLoadPosition","subtype":"PROCEDURE","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"LoadMatching@UDVLPLL4DATASRV.linklogi.com","id":"d9"}},{"field":"Schema","value":"dbo"},{"field":"Name","value":"usp_GetLoadPosition"},{"field":"Type","value":"Procedure"}],"script":"CREATE PROCEDURE [dbo].[usp_GetLoadPosition] \r\n    @Token INT\r\nAS \r\n-----------------------------------------------------------------------\r\n-- PROCEDURE NAME : usp_GetLoadPosition\r\n--------------------------------------------------------------------------\r\n-- DESCRIPTION    : Returns a list of geo points for a given load\r\n--\r\n-- ASSUMPTIONS    : \r\n-- CALLED BY      : \r\n-- EXECUTION FREQUENCY : OnDemand\r\n--\r\n-- INPUT PARAMS   : @Token - Id of the load\r\n-- OUTPUT PARAMS  :\r\n-- STATUS RETURN  : \r\n--------------------------------------------------------------------------\r\n-- HISTORY :\r\n-- AUTHOR    DATE       DESCRIPTION\r\n-- Vadym     2018.02.23 Initial Release\r\n-- Hiro      2018.06.27 Added EquipmentId and EToken\r\n---------------------------------------------------------------------------\r\nBEGIN\r\nSET NOCOUNT ON;\r\n\r\n\tdeclare @lastId int;\r\n\r\n\tselect \r\n\t\t@lastId = max([MessageId])\r\n\tfrom\r\n\t\t[dbo].[LoadPosition]\r\n\twhere\r\n\t\tLoadId = @Token and\r\n\t\tLoadStatus <> 'R';\r\n\t\t\r\n\t\r\n\tselect *\r\n\tfrom\r\n\t(\r\n\tselect\r\n\t\tlp.[LoadId],\r\n\t\tlp.[CustCD],\r\n\t\tlp.[UserId],\r\n\t\tlp.LoadStatus,\r\n\t\tim.[GPSLongitude] Lon,\r\n\t\tim.[GPSLatitude] Lat,\r\n\t\tim.MessageId,\r\n        lp.EquipmentID,\r\n        lp.EToken\r\n\tfrom\r\n\t\t[dbo].[LoadPosition] lp left join\r\n\t\tGeo.dbo.InMessage im on lp.UserId = im.Userid\r\n\twhere\r\n\t\tlp.LoadId = @Token and\r\n\t\tlp.LoadStatus = 'R' and\r\n\t\t((im.MessageId >= lp.[MessageId]) and \r\n\t\t((@lastId is not null and im.MessageId < @lastId) or (@lastId is null)))\r\n\r\n\tunion all\r\n\r\n\tselect\r\n\t\tlp.[LoadId],\r\n\t\tlp.[CustCD],\r\n\t\tlp.[UserId],\r\n\t\tlp.LoadStatus,\r\n\t\tlp.Lon,\r\n\t\tlp.Lat,\r\n\t\tlp.MessageId,\r\n        lp.EquipmentID,\r\n        lp.EToken\r\n\tfrom\r\n\t\t[dbo].[LoadPosition] lp\r\n\twhere\r\n\t\tlp.LoadId = @Token and\r\n\t\tlp.LoadStatus <> 'R'\r\n\t) t\r\n\torder by\r\n\t\tt.MessageId\r\n\r\nEND","parameters":[{"name":"Token","description":null,"mode":"IN","data_type":"int","custom_fields":{}}],"dependencies":null,"imported_at":"2021-07-29 12:59"};