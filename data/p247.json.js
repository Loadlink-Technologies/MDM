window.repositoryObject = {"parameters_custom_fields":[],"object_id":"p247","name":"usp_GetCarrier","subtype":"PROCEDURE","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"LoadMatching@UDVLPLL4DATASRV.linklogi.com","id":"d9"}},{"field":"Schema","value":"dbo"},{"field":"Name","value":"usp_GetCarrier"},{"field":"Type","value":"Procedure"}],"script":"CREATE PROCEDURE [dbo].[usp_GetCarrier] \r\n  @UserID      INT \r\n ,@SrceSt      CHAR(2) = ''\r\n ,@SrceCity    VARCHAR(50) = ''\r\n ,@SrceRadius  INT = 0    \r\n ,@DestSt      CHAR(2) = ''\r\n ,@DestCity    VARCHAR(50) = ''\r\n ,@DestRadius  INT = 0        \r\n ,@VType       INT = 0        \r\n ,@VSize       INT = 0        \r\n ,@PAttrib     INT = 0\r\n ,@CompanyName VARCHAR(50) = ''\r\n ,@GetDat      BIT = 0 \r\n ,@GetMexico   BIT = 0\r\n ,@ServerName  VARCHAR(50) = ''\r\n ,@Version     VARCHAR(50) = 'V4.00'\r\n\r\n--WITH \r\n---- Disable the native compiled stored procedures \r\n\r\n--------------------------------------------------------------------------\r\n--PROCEDURE NAME : usp_GetCarrier\r\n--------------------------------------------------------------------------\r\n-- DESCRIPTION    : Get Carrier Search\r\n--\r\n-- CALLED BY      : LoadMatching Web API \r\n-- EXECUTION FREQUENCY : \r\n-- \r\n-- INPUT PARAMS   : @UserID             - Caller UserID\r\n--                  @SrceSt             - Source State/Prov\r\n--                  @SrceCity           - Source City\r\n--                  @SrceRadius         - Source Radius\r\n--                  @DestSt             - Destination State/Prov\r\n--                  @DestCity           - Destination City\r\n--                  @DestRadius         - Destination Radius\r\n--                  @VType              - Vehicle Type Code\r\n--                  @VSize              - Vehicle Size Code\r\n--                  @GetDat             - Include Equipment from DAT (Not Implemented)\r\n--                  @ServerName         - Name of Machinename of caller (IIS) (Not Implemented)\r\n--                  @Version            - Client Version (Not Implemented)\r\n--                  @CompanyName        - Name of Company to search\r\n--                  @PAttrib            - Posting Attribute Code\r\n--                  @GetMexico          - Include Data from Mexico\r\n--                 \r\n-- OUTPUT PARAMS  :\r\n-- STATUS RETURN  : \r\n--------------------------------------------------------------------------\r\n-- HISTORY : \r\n-- AUTHOR       DATE        DESCRIPTION\r\n-- Hiro         2018.07.13  Initial Development\r\n-- Vevian       2018.08.20  Add \"Excluded\" logic - Hide Excluded Customers\r\n-- Hiro         2018.09.06  Added SubscriberType to identify: Link-P (Platform), Link-L (Legacy), DAT\r\n-- Vevian\t\t2019.09.17\tLLSIM-3336: Don't display globally excluded accounts in Carrier Search\r\n-- Nesrin       2020.02.11  LLSIM-3932: Update GETCarrier sp to display correct value of Equifax score\r\n--                                      If the value is 0 --> display as 0 instead of -1\r\n-- Nesrin       2020.04.07 LLSIM-4061: Script current Loadmatching DB and create a new one with no memory optimized tables\r\n--------------------------------------------------------------------------\r\nAS\r\nSET NOCOUNT ON\r\n\r\nDECLARE @SrcePointNotSet BIT = 0\r\n      , @DestPointNotSet BIT = 0\r\n      , @MaxRecords      INT = 5000\r\n      , @SrceLong         DECIMAL(9,5) = 0\r\n      , @SrceLat          DECIMAL(9,5) = 0\r\n      , @DestLong        DECIMAL(9,5) = 0\r\n      , @DestLat         DECIMAL(9,5) = 0\r\n      , @JustCompany     BIT = 0\r\n      , @ServerDate      DATETIME\r\n      , @CustCD          VARCHAR(10) = ''\r\n\r\nSET @ServerDate = CONVERT(Varchar(10),GETUTCDATE(),126)\r\n\r\n---- Get the CustCd from Account Table for Now \r\nSET @CustCD = dbo.udf_GetCustCd (@UserId)\r\n\r\n-----------------------------------------------------------------------------------------------\r\n--** Source Location **--\r\nIF (@SrceSt IS NULL OR @SrceSt = '') \r\n    BEGIN\r\n      SET @SrcePointNotSet = 1\r\n      SET @SrceRadius = 0\r\n      SET @SrceCity   = ''\r\n      SET @SrceSt  = ''\r\n      SET @SrceLong   = 0\r\n      SET @SrceLat    = 0\r\n    END\r\nELSE\r\n    BEGIN \r\n      IF (@SrceCity IS NULL OR @SrceCity = '')         \r\n         BEGIN\r\n           SET @SrceLat  = 0.0 \r\n           SET @SrceLong = 0.0\r\n           SET @SrceCity = ''\r\n           SET @SrceRadius = 0  -- Search is by State\r\n         END\r\n      ELSE\r\n         BEGIN\r\n           SET @SrceCity = UPPER(@SrceCity)\r\n           SELECT @SrceLat  = Lat,\r\n                  @SrceLong = Long\r\n             FROM Point \r\n            WHERE City      = @SrceCity\r\n              AND StateCode = @SrceSt\r\n           IF ((@SrceLat  IS NULL OR @SrceLat  = 0.0) AND (@SrceLong IS NULL OR @SrceLong = 0.0))\r\n              BEGIN\r\n                SET @SrceCity = ''\r\n                SET @SrceLat  = 0.0\r\n                SET @SrceLong = 0.0\r\n                SET @SrceRadius = 0  -- Search is by State\r\n              END\r\n         END\r\n    END\r\n\r\n--** Destination Location **--\r\nIF (@DestSt IS NULL OR @DestSt = '') \r\n    BEGIN\r\n      SET @DestPointNotSet = 1\r\n      SET @DestRadius = 0\r\n      SET @DestCity   = ''\r\n      SET @DestSt  = ''\r\n      SET @DestLong   = 0\r\n      SET @DestLat    = 0\r\n    END\r\nELSE \r\n    BEGIN \r\n      IF (@DestCity IS NULL OR @DestCity = '')\r\n         BEGIN\r\n           SET @DestLat  = 0.0\r\n           SET @DestLong = 0.0\r\n           SET @DestCity = ''\r\n           SET @DestRadius = 0 -- Search is by State \r\n         END\r\n      ELSE\r\n         BEGIN\r\n           SET @DestCity = UPPER(@DestCity)\r\n           SELECT @DestLat  = Lat,\r\n                  @DestLong = Long\r\n             FROM Point \r\n            WHERE City      = @DestCity\r\n              AND StateCode = @DestSt\r\n           IF ((@DestLat  = 0.0 OR @DestLat  IS NULL) AND (@DestLong = 0.0 OR @DestLong IS NULL))\r\n              BEGIN\r\n                SET @DestCity = ''\r\n                SET @DestLat  = 0.0\r\n                SET @DestLong = 0.0\r\n                SET @DestRadius = 0 -- Search is by State\r\n              END\r\n         END\r\n    END\r\n\r\nIF (LEN(@CompanyName)>0 AND @SrcePointNotSet = 1 AND @DestPointNotSet = 1)\r\n   SET @JustCompany = 1\r\n-----------------------------------------------------------------------------------------------\r\nSET ROWCOUNT @MaxRecords\r\n\t          \r\nSELECT \r\n\r\n       E.CustCd, \r\n       E.Token,\r\n       E.DateAvail,\r\n       E.SrceCity + ', ' + E.SrceSt SrceStateCity,\r\n       E.DestCity + ', ' + E.DestSt DestStateCity,\r\n       ISNULL(A.CommonName,'NA') CompanyName ,\r\n       E.CreatedOn PostDate,\r\n       vs.Code VehicleSize ,\r\n       dbo.udf_VTypeToString(E.VType) VehicleType ,\r\n       dbo.udf_PostingAttributeToString(E.PAttrib) PostingAttrib ,\r\n       E.Comment, \r\n       'Link' AS CustomerOf,\r\n\t   ISNULL(Idx.Equifax_PAYMNTINDX ,-1) Equifax,     \r\n       ISNULL(Idx.TranscreditCA_Analysis,-1) TCC ,\r\n       -1 TCUS ,\r\n       IIF(Cn.LToken IS NULL,'', 'Y') Contacted, \r\n       E.CreatedBy,\r\n       A.SubscriberType \r\n       FROM dbo.EquipmentPosting E WITH(NOLOCK)\t\t\t\t\t\r\n                    INNER JOIN Main.dbo.Account A WITH(NOLOCK) ON A.CustCD = E.CustCd\r\n                    LEFT JOIN dbo.Contacted Cn ON (Cn.EToken   = E.Token AND  -- #1\r\n                                                   Cn.LToken   = 0       AND \r\n                                                   Cn.CustCd   = @CustCd AND \r\n                                                   Cn.CnCustCd = E.CustCd   )\r\n                    INNER JOIN Finance.dbo.FinanceIndex Idx WITH(NOLOCK) on Idx.CustCD = E.CustCD  \r\n\t\t\t\t\tLEFT JOIN dbo.VehicleSize vs ON E.VSize = vs.Value AND vs.PostType = 'E'\r\n      WHERE (E.DeletedOn IS NULL)\r\n \t\tAND (E.PStatus = 'O') -- Return only Open Posting\r\n        AND (DateAvail >= @ServerDate)\r\n\t\tAND (@GetMexico = 1 OR (E.SrceSt <> 'MX' AND E.DestSt <> 'MX')) -- Exclude Mexico data if GetMexico is 0(Default)\r\n\t\tAND (@PAttrib = 0 OR (@PAttrib & E.PAttrib) > 0)\r\n\t\tAND (@VType = 0 OR (@VType & E.VType) > 0)\r\n\t\tAND (@VSize = 0 OR (@VSize & E.VSize) > 0)\r\n--\t\tAND (A.Status = 1) -- In the future include Active Customer's Posting\r\n\t\tAND ((@JustCompany = 1 AND A.CommonName like @CompanyName + '%') OR\r\n\t\t\t (@JustCompany = 0 AND (    (@CompanyName = '' OR A.CommonName like @CompanyName + '%')\r\n\t\t\t\t\t\t\t\t\tAND ((@SrcePointNotSet = 1) OR\r\n\t\t\t\t\t\t\t\t\t\t (@SrceSt = E.SrceSt AND @SrceCity  = '') OR\r\n\t\t\t\t\t\t\t\t\t\t (@SrceSt = E.SrceSt AND @SrceCity  = E.SrceCity AND @SrceRadius = 0) OR\r\n\t\t\t\t\t\t\t\t\t\t (@SrceRadius > 0 AND @SrceRadius >= dbo.udf_GetDistance(@SrceLat, @SrceLong, E.SrceLat, E.SrceLong))) \r\n\t\t\t\t\t\t\t\t\tAND ((@DestPointNotSet = 1) OR\r\n\t\t\t\t\t\t\t\t\t\t (@DestSt = E.DestSt AND @DestCity = '') OR\r\n\t\t\t\t\t\t\t\t\t\t (@DestSt = E.DestSt AND @DestCity  = E.DestCity AND @DestRadius = 0) OR\r\n\t\t\t\t\t\t\t\t\t\t (@DestRadius > 0 AND @DestRadius >= dbo.udf_GetDistance(@DestLat, @DestLong, E.DestLat, E.DestLong))))))\r\n\t\tAND (NOT EXISTS (SELECT 'X' FROM Exclude x (NOLOCK) WHERE x.CustCd = @CustCd  AND x.ExcludeCustCd = E.CustCd)) \r\n\t\tAND (NOT EXISTS (SELECT 'X' FROM Exclude x (NOLOCK) WHERE x.CustCd = E.CustCd AND x.ExcludeCustCd = @CustCd )) \r\n\t\tAND A.GlobalExcluded = 0\r\n\r\norder by PostDate desc\r\n\r\nSET ROWCOUNT 0","parameters":[{"name":"UserID","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"SrceSt","description":null,"mode":"IN","data_type":"char(2)","custom_fields":{}},{"name":"SrceCity","description":null,"mode":"IN","data_type":"varchar(50)","custom_fields":{}},{"name":"SrceRadius","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"DestSt","description":null,"mode":"IN","data_type":"char(2)","custom_fields":{}},{"name":"DestCity","description":null,"mode":"IN","data_type":"varchar(50)","custom_fields":{}},{"name":"DestRadius","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"VType","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"VSize","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"PAttrib","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"CompanyName","description":null,"mode":"IN","data_type":"varchar(50)","custom_fields":{}},{"name":"GetDat","description":null,"mode":"IN","data_type":"bit","custom_fields":{}},{"name":"GetMexico","description":null,"mode":"IN","data_type":"bit","custom_fields":{}},{"name":"ServerName","description":null,"mode":"IN","data_type":"varchar(50)","custom_fields":{}},{"name":"Version","description":null,"mode":"IN","data_type":"varchar(50)","custom_fields":{}}],"dependencies":null,"imported_at":"2021-07-29 12:59"};