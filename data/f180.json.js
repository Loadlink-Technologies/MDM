window.repositoryObject = {"parameters_custom_fields":[],"object_id":"f180","name":"udf_GetEquipmentLeadsCount","subtype":"FUNCTION","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"LoadMatching@UDVLPLL4DATASRV.linklogi.com","id":"d9"}},{"field":"Schema","value":"dbo"},{"field":"Name","value":"udf_GetEquipmentLeadsCount"},{"field":"Type","value":"Function"}],"script":"CREATE FUNCTION [dbo].[udf_GetEquipmentLeadsCount](\r\n  @CustCD\t\t\tVarchar(10)     \r\n ,@EToken\t\t\tINT \r\n ,@GetDAT\t\t\tBIT \r\n \r\n )\r\n RETURNS INT\r\n  \r\nAS\r\n--------------------------------------------------------------------------\r\n--FUNCTION NAME : udf_GetEquipmentLeadsCount\r\n--------------------------------------------------------------------------\r\n-- DESCRIPTION    : Get Equipment Leads count for the posting\r\n--\r\n-- CALLED BY      : usp_GetEquipmentPosting SP \r\n--\r\n-- INPUT PARAMS   : @CustCd\t\t\t- Caller CustCd\r\n--                  @EToken\t\t\t- Equipment Token is pass if retrieving the Leads Count for 1 Load Posting         \r\n--                  @GetDAT\t\t\t- flag to include DAT Leads count or not (should not include DAT count if not subscribed to DAT feature)      \r\n\r\n--------------------------------------------------------------------------\r\n-- HISTORY : \r\n-- AUTHOR    DATE\t\t\tDESCRIPTION\r\n-- Nesrin   2020.02.28      LLSIM-3990: Create new function to return leads count\r\n--                          Return the leads count with the equipment posting list\r\n-- Nesrin    2020.04.14\t\tLLSIM-4061: Script current Loadmatching DB \r\n--\t\t\t\t\t\t\tand create a new one with no memory optimized tables\r\n--------------------------------------------------------------------------\r\n\r\nBEGIN\r\n\r\nDeclare @LeadsCount INT = 0\r\n\r\n\r\nIF (@GetDAT = 1)\r\n\tBEGIN\r\n\t\tSELECT\t@LeadsCount = SUM(LeadCount)  FROM\r\n\t\t(\r\n\t\t\t-- EQUIPMENT LEADS\r\n\t\t\t\tSELECT count(*) LeadCount\r\n\t\t\t\t\t\tFROM\tdbo.EquipmentLead EL WITH(NOLOCK) \r\n\t\t\t\t\t\t\t\tINNER JOIN dbo.LoadPosting L WITH(NOLOCK) ON EL.LToken = L.Token\r\n\t\t\t\t\t\tWHERE\tEL.EToken = @EToken  \r\n\t\t\t\t\t\t\t\tAND (L.DeletedOn IS NULL)\r\n\t\t\t\t\t\t\t\tAND L.PStatus in('O','P')-- Open & Pending\r\n\t\t\t\t\t\t\t\tAND (NOT EXISTS ( SELECT 'X' FROM dbo.Exclude x WITH(NOLOCK) WHERE x.CustCd = @CustCd  AND x.ExcludeCustCd = L.CustCd) ) \r\n\t\t\t\t\t\t\t\tAND (NOT EXISTS ( SELECT 'X' FROM dbo.Exclude x WITH(NOLOCK) WHERE x.CustCd = L.CustCd AND x.ExcludeCustCd = @CustCd ) )  \r\n\t\t\t\t\t\t\t\t--AND EL.LeadType <> 'S'\r\n\t\t\t\t\t\t\r\n\r\n\t\t\t\r\n\t\t\tUNION ALL\r\n\r\n\t\t\t-- DAT EQUIPMENT LEADS\r\n\t\t\t\tSELECT\tcount(*) LeadCount\r\n\t\t\t\t\t\tFROM\tdbo.DATEquipmentLead EL WITH(NOLOCK)\r\n\t\t\t\t\t\t\t\tINNER JOIN dbo.DATLoadPosting L WITH(NOLOCK) ON EL.LToken = L.Token\r\n\t\t\t\t\t\tWHERE\tEL.EToken = @EToken\r\n\t\t\t\t\t\t\t\tAND (L.DeletedOn IS NULL)\r\n\t\t\t\t\t\t\t\tAND (NOT EXISTS ( SELECT 'X' FROM dbo.Exclude x WITH(NOLOCK) WHERE x.CustCd = @CustCd  AND x.ExcludeCustCd = L.CustCd) ) \r\n\t\t\t\t\t\t\t\tAND (NOT EXISTS ( SELECT 'X' FROM dbo.Exclude x WITH(NOLOCK) WHERE x.CustCd = L.CustCd AND x.ExcludeCustCd = @CustCd ) ) \r\n\t\t\t\t\t\t\t\t--AND EL.LeadType <> 'S'\r\n\t\t\t\t\t\t\r\n\r\n\r\n\t\t) A\r\n\t\r\n\t\tRETURN @LeadsCount\r\n\r\n\tEND\r\n\t\r\nELSE\r\n\tBEGIN\r\n\t\tSELECT\t@LeadsCount = COUNT(*)\r\n\t\t\t\t\tFROM\tdbo.EquipmentLead EL  WITH(NOLOCK)\r\n\t\t\t\t\t\t\tINNER JOIN dbo.LoadPosting L WITH(NOLOCK) ON EL.LToken = L.Token\r\n\t\t\t\t\tWHERE\tEL.EToken = @EToken  \r\n\t\t\t\t\t\t\tAND (L.DeletedOn IS NULL)\r\n\t\t\t\t\t\t\tAND L.PStatus in('O','P')-- Open & Pending\r\n\t\t\t\t\t\t\tAND (NOT EXISTS ( SELECT 'X' FROM dbo.Exclude x WITH(NOLOCK) WHERE x.CustCd = @CustCd  AND x.ExcludeCustCd = L.CustCd) ) \r\n\t\t\t\t\t\t\tAND (NOT EXISTS ( SELECT 'X' FROM dbo.Exclude x WITH(NOLOCK) WHERE x.CustCd = L.CustCd AND x.ExcludeCustCd = @CustCd ) ) \r\n\t\t\t\t\t\t\t--AND EL.LeadType <> 'S' \r\n\t\t\t\t\t\r\n\r\n\t\t\r\n\tEND\r\n\t\r\n\r\n\tRETURN @LeadsCount\r\n--\t @LeadsCount\r\nEND","parameters":[{"name":"Returns","description":null,"mode":"OUT","data_type":"int","custom_fields":{}},{"name":"CustCD","description":null,"mode":"IN","data_type":"varchar(10)","custom_fields":{}},{"name":"EToken","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"GetDAT","description":null,"mode":"IN","data_type":"bit","custom_fields":{}}],"dependencies":null,"imported_at":"2021-07-29 12:59"};