window.repositoryObject = {"parameters_custom_fields":[],"object_id":"p302","name":"usp_MatchEquipmentPosting","subtype":"PROCEDURE","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"LoadMatching@UDVLPLL4DATASRV.linklogi.com","id":"d9"}},{"field":"Schema","value":"dbo"},{"field":"Name","value":"usp_MatchEquipmentPosting"},{"field":"Type","value":"Procedure"}],"script":"CREATE PROCEDURE [dbo].[usp_MatchEquipmentPosting] \r\n  @EquipToken    int\r\n ,@CustCd        varchar(10)\t= ''\r\n ,@UserID        int\t\t\t= 0\r\n                 \r\n ,@SrceID        int\t\t\t= 0\r\n ,@SrceSt        char(2)\t\t= ''\r\n ,@SrceLong      float\t\t\t= ''\r\n ,@SrceLat       float\t\t\t= ''\r\n ,@SrceCountry   int\t\t\t= 0\r\n ,@SrceRadius    int\t\t\t= 0\r\n                 \r\n ,@DestID        int\t\t\t= 0\r\n ,@DestSt        char(2)\t\t= ''\r\n ,@DestLong      float\t\t\t= ''\r\n ,@DestLat       float\t\t\t= ''\r\n ,@DestCountry   int\t\t\t= 0\r\n ,@DestRadius    int\t\t\t= 0\r\n                 \r\n ,@DateAvail     datetime\t\t= NULL\r\n ,@VSize         int\t\t\t= 0\r\n ,@VType         INT\t\t\t= 0\r\n ,@PAttrib       INT\t\t\t= 0\r\n                 \r\n ,@PostMode      char(1)\t\t= 'A' \r\n ,@GlobalExclude bit\t\t\t= 0\r\n ,@NetworkId     int\t\t\t= 0 \r\n ,@Corridor      char(1)\t\t= 'R' \r\n ,@OriginalToken int\t\t\t= 0 \r\n\r\nAS\r\nBEGIN\r\n\r\n--------------------------------------------------------------------------\r\n--PROCEDURE NAME : usp_MatchEquipmentPosting\r\n--------------------------------------------------------------------------\r\n-- DESCRIPTION    : Perform Equipment Matching\r\n--\r\n-- CALLED BY      : LoadMatching Web API \r\n-- EXECUTION FREQUENCY : \r\n-- \r\n-- INPUT PARAMS   : @EquipToken    = Newly created Equipment Posting's Token\r\n--                  @CustCD        = Customer Code        \r\n--                  @DateAvail     = Availab\r\n--                                 \r\n--                  @SrceID        = Source Point ID from Point table        \r\n--                  @SrceCity      = Source City\r\n--                  @SrceSt        = Source State      \r\n--                  @SrceLong      = Source Longitude      \r\n--                  @SrceLat       = Source Latitude       \r\n--                  @SrceRadius    = Source Radius    \r\n--                                 \r\n--                  @DestID        = Destination City      \r\n--                  @DestCity      = Destination State          \r\n--                  @DestSt        = Destination Longitude      \r\n--                  @DestLong      = Destination Longitude       \r\n--                  @DestLat       = Destination Latitude       \r\n--                  @DestRadius    = Destination Radius\r\n--                                 \r\n--                  @VSize         = Vehicle Size in numeric form      \r\n--                  @VType         = Vehilce Type in numeric form  \r\n--                  @Comment       = Commment\r\n--                  @PostMode      = A(default): Visible to all, P: Private Network\r\n--                  @ClientRefNum  = Client internal Reference Number \r\n--                  @ProductName   = Caller's Product Name\r\n--                  @PAttrib       = Posting Attribute in numeric form\r\n--                  @CreatedBy     = UserId of caller\r\n--                  @NetworkId     = When @PostMode is P then NetworkID otherwise 0\r\n--                  @Corridor      = R(default): Radius, C:Corridor mode\r\n--                  @OriginalToken = 0(default): If non zero then it will contain Token value from Legacy system \r\n--                 \r\n-- OUTPUT PARAMS  :\r\n-- STATUS RETURN  : \r\n--------------------------------------------------------------------------\r\n-- HISTORY : \r\n-- AUTHOR    DATE       DESCRIPTION\r\n-- Hiro      2017.03.09 Initial Development\r\n-- Hiro      2017.07.27 Use the Country code in Posting for Country code matching\r\n-- Hiro      2017.09.29 Updated the VehicleSize definition\r\n-- Hiro      2017.11.14 Added PAttrib to Matching Logic\r\n-- Hiro      2017.11.27 Added Private Network Logic\r\n-- Hiro      2018.04.11 Added Private Network Logic for Equipment and Modified the Corridor\r\n-- Hiro      2018.07.17 Changed the CreatedOn as UTC Time\r\n-- Hiro      2018.08.14 Fixed PAttrib bug when Empty Equipemnt PAttrib will ignore Load's PAttrib \r\n-- Hiro      2018.09.07 OriginalToken input parameter will have Token from Legacy system if exist.\r\n-- Hiro      2018.09.12 Posting Status PStatus has to be Open (O)\r\n-- Hiro      2018.09.12 Ignore Legacy Posting from Secondary (livelead) matching \r\n-- Hiren     2019.03.06 Remove attribute based matching (LLSIM-2678) \r\n-- Vevian\t 2019.08.09\tLLSIM-3111: Implement Global exclude logic in Matching process\r\n-- Vevian\t 2020.04.08\tLLSIM-4061: Code optimization after converting memory-optimized tables to Desk-based tables\r\n-- Nesrin    2020.04.06 LLSIM-4075: As a Carrier I am not able to match against Load postings \r\n--                                  when my posting is at status = \"Pending\"\r\n--------------------------------------------------------------------------\r\n--SET NOCOUNT ON\r\n\r\nDECLARE @fCosSrceLat\tfloat\r\nDECLARE @fSinSrceLat    float\r\nDECLARE @fCosDestLat    float\r\nDECLARE @fSinDestLat    float\r\nDECLARE @fPo2           float\r\n\r\nDECLARE @GetDate\t\tdatetime  \r\nSET @GetDate = GETUTCDATE()\r\n\r\nDECLARE\t@SecondaryMatch\tchar(1) = 'S'\r\nDECLARE\t@PrimaryMatch\tchar(1) = 'P'\r\n\r\nDECLARE @AllVSize       int = 15 -- Full Truckload, 3/4 Truckload, Half Truckload, 1/4 Truckload\r\n-----------------------------------------------------------------------------------------------\r\n-- Setup constant values for range calculations -- revised 10/27/99 JAM\r\n-----------------------------------------------------------------------------------------------\r\nSET @fPo2        = 90.0  --DEGREES(pi()/2)\r\n\r\nSET @fCosSrceLat = cos(radians(@fPo2-@SrceLat))\r\nSET @fSinSrceLat = sin(radians(@fPo2-@SrceLat))\r\nSET @fCosDestLat = cos(radians(@fPo2-@DestLat))\r\nSET @fSinDestLat = sin(radians(@fPo2-@DestLat))\r\n\r\n-----------------------------------------------------------------------------------------------\r\n-- If EquipToken is not 0 then retrieve the posting information from database\r\n-----------------------------------------------------------------------------------------------\r\nIF (@EquipToken <> 0)\r\nBEGIN\r\n    SELECT\r\n      @CustCd        = CustCd\r\n     ,@UserID        = CreatedBy     \r\n                                 \r\n     ,@SrceID        = SrceID     \r\n     ,@SrceSt        = SrceSt     \r\n     ,@SrceLong      = SrceLong   \r\n     ,@SrceLat       = SrceLat    \r\n     ,@SrceCountry   = SrceCountry\r\n     ,@SrceRadius    = SrceRadius \r\n                                 \r\n     ,@DestID        = DestID     \r\n     ,@DestSt        = DestSt     \r\n     ,@DestLong      = DestLong   \r\n     ,@DestLat       = DestLat    \r\n     ,@DestCountry   = DestCountry\r\n     ,@DestRadius    = DestRadius \r\n                                 \r\n     ,@DateAvail     = DateAvail  \r\n     ,@VSize         = VSize      \r\n     ,@VType         = VType      \r\n     ,@PAttrib       = PAttrib      \r\n                                 \r\n     ,@PostMode      = PostMode   \r\n     ,@NetworkId     = NetworkId   \r\n     ,@Corridor      = Corridor   \r\n     ,@OriginalToken = OriginalToken   \r\n\r\n    FROM dbo.EquipmentPosting\r\n    WHERE Token = @EquipToken\r\nEND \r\n\r\n-----------------------------------------------------------------------------------------------\r\n-- If equip and load are at the same point, and not at zero longitude, \r\n-- THEN nudge the destination just a little so the math doesn't blow up (divide by zero).\r\n-----------------------------------------------------------------------------------------------\r\nIF ( (@SrceLong = @DestLong) AND \r\n     (@SrceLat  = @DestLat ) AND \r\n     (@SrceLong <> 0.0 )\r\n   )\r\n   BEGIN\r\n      SET @DestLong = @DestLong + 0.0001\r\n      SET @DestLat  = @DestLat  + 0.0001\r\n   END\r\n\r\n-----------------------------------------------------------------------------------------------\r\n-- PART 0 If OriginalToken is 0 then it was created by Platform user, otherwise Posting came from Legacy system\r\n-----------------------------------------------------------------------------------------------\r\nIF (@OriginalToken = 0)     \r\n    BEGIN\r\n    -----------------------------------------------------------------------------------------------\r\n    -- PART 1 Insert Equipment matches for my posting\r\n    -----------------------------------------------------------------------------------------------\r\n    \r\n    -----------------------------------------------------------------------------------------------\r\n    --Corridor matching \r\n    -----------------------------------------------------------------------------------------------\r\n    IF (@Corridor  = 'C')\r\n       BEGIN\r\n        -----------------------------------------------------------------------------------------------\r\n        -- Calculate corridor corner points in Lat/Long\r\n        -----------------------------------------------------------------------------------------\r\n        DECLARE @fTheta float\r\n        DECLARE @fPhi   float\r\n        DECLARE @lAB    float\r\n        DECLARE @uABx   float\r\n        DECLARE @uABy   float\r\n        \r\n        DECLARE @Cx     float\r\n        DECLARE @Cy     float\r\n        DECLARE @Dx     float\r\n        DECLARE @Dy     float\r\n        DECLARE @Ex     float\r\n        DECLARE @Ey     float\r\n        DECLARE @Fx     float\r\n        DECLARE @Fy     float\r\n        DECLARE @Mx     float\r\n        DECLARE @My     float     \r\n        DECLARE @Nx     float\r\n        DECLARE @Ny     float\r\n        DECLARE @Ox     float\r\n        DECLARE @Oy     float\r\n        DECLARE @Px     float\r\n        DECLARE @Py     float\r\n         \r\n        -- Calculate the corridor parameters.  This assumes a flat earth approximation!! \r\n        SET @fTheta = degrees( @SrceRadius / 3959.0 )\r\n        SET @fPhi   = degrees( @DestRadius / 3959.0 )\r\n         \r\n        SET @lAB    = SQRT( (@DestLong - @SrceLong) * (@DestLong - @SrceLong) + \r\n                            (@DestLat  - @SrceLat ) * (@DestLat  - @SrceLat )\r\n                          )\r\n        SET @uABx   = (@DestLong - @SrceLong) / @lAB\r\n        SET @uABy   = (@DestLat  - @SrceLat ) / @lAB\r\n        \r\n        SET @Cx     = @fTheta * -@uABy\r\n        SET @Cy     = @fTheta *  @uABx\r\n        SET @Ex     = @fPhi   * -@uABy\r\n        SET @Ey     = @fPhi   *  @uABx\r\n        \r\n        -- Set the 4 points of the trapezoid (M,N,O,P) \r\n        SET @Px = @SrceLong - @Cx\r\n        SET @Py = @SrceLat  - @Cy\r\n        SET @Ox = @SrceLong + @Cx\r\n        SET @Oy = @SrceLat  + @Cy\r\n        SET @Mx = @DestLong - @Ex\r\n        SET @My = @DestLat  - @Ey\r\n        SET @Nx = @DestLong + @Ex\r\n        SET @Ny = @DestLat  + @Ey\r\n    \r\n        -----------------------------------------------------------------------------------------------\r\n        -- Load up local variables from processed records\r\n        -----------------------------------------------------------------------------------------------\r\n        INSERT INTO dbo.EquipmentLead\r\n    \t (\r\n    \t\t [CustCd] \r\n    \t\t,[EToken] \r\n    \t\t,[LToken]\r\n    \t\t,[CreatedOn]\r\n    \t\t,[CreatedBy]\r\n    \t\t,[LeadType]\r\n    \t)\r\n        SELECT @CustCd\r\n              ,@EquipToken\r\n              ,l.Token\r\n              ,@GetDate\r\n    \t\t  ,@UserID\r\n    \t\t  ,@PrimaryMatch\r\n\t\tFROM dbo.LoadPosting l \r\n    \r\n          -----------------------------------------------------------\r\n          -- Common lead filtering\r\n          ----------------------------------------------------------- \r\n\t\tWHERE \r\n\t\t\t-- Available date matches\r\n\t\t\t(l.DateAvail >= @DateAvail)\r\n            -- Vehicle size matches\r\n            AND ((@VSize & l.VSize & @AllVSize) > 0) \r\n            -- Vechicle Type match\r\n            AND ((@VType & l.VType) > 0) \r\n            -- Posting Attribute match (Carrier)\r\n\t\t\t--Commented By Hiren \r\n            --AND ((@PAttrib & l.PAttrib) >= l.PAttrib) \r\n            -- Country Border restriction conditions for equipment\r\n            AND (l.SrceCountry = @SrceCountry   AND l.DestCountry = @DestCountry ) \r\n\t\t\t-- .... END of country border closing tests\r\n           -- Used the Removed column instead of Removed table.\r\n           AND (l.DeletedOn IS NULL)   \r\n           --Check if Load Posting is Private Network \r\n           AND (l.PostMode = 'A' OR (EXISTS(SELECT 'X' FROM dbo.NetworkMembers \r\n                                                    WHERE NetworkId = l.NetworkId \r\n                                                    AND MemberCustCD = @CustCd)))    \r\n           --Check if Equipment Posting is Private Network \r\n           AND (@PostMode = 'A' OR (EXISTS(SELECT 'X' FROM dbo.NetworkMembers \r\n                                                    WHERE NetworkId = @NetworkId \r\n                                                    AND MemberCustCD = l.CustCd)))  \r\n           -- Posting Status has to be Open\r\n           AND (l.PStatus IN ('O','P'))\r\n\r\n\t\t   -- Exclude matches from Globally-Excluded customers\r\n\t\t   AND (l.CustCd NOT IN (SELECT CustCd FROM Main.dbo.Account WHERE GlobalExcluded = 1))    \r\n           -- Start GEOGRAPHIC CONDITIONS ... one of 4 must be satisfied: \r\n           AND (  --    1a) Load source in truck source Range Circle AND LDest in truck's dest Range Circle    OR \r\n                  --    1b) Load source in truck source Range Circle AND LDest in truck's corridor AND Load going in same general direction as truck          OR\r\n                  --    2a) LSource in truck's Corridor AND LDest in Truck's dest Range Circle AND Load going in same general direction as truck      OR\r\n                  --    2b) LSource in truck's Corridor AND LDest in truck's corridor AND Load going in general direction as truck\r\n\t\t\t\t   \r\n                  (   -- 1a condition: Load source in truck source Range Circle AND LDest in truck's dest Range Circle\r\n                      -- 1a i Condition Load source in truck source Range Circle\r\n                      (  (@SrceLong <> 0.0 AND @SrceLong = l.SrceLong AND @SrceLat = l.SrceLat)\r\n                         OR\r\n                         (@SrceLong <> 0.0 AND  @SrceRadius >= dbo.udf_GetDistance( @SrceLat, @SrceLong, l.SrceLat, l.SrceLong)\r\n                          )\r\n                      ) -- END of 1a i condition\r\n                      AND -- 1a ii condition: LDest in truck's dest Range Circle\r\n                      (  (@DestLong <> 0.0 AND @DestLong = l.DestLong AND @DestLat=l.DestLat) \r\n                         OR\r\n                         (@DestLong <> 0.0 AND @DestRadius >= dbo.udf_GetDistance( @DestLat, @DestLong, l.DestLat, l.DestLong)\r\n                         )\r\n                      ) -- END of 1a ii condition.                   \r\n                  ) -- END of 1a condition: Range Circles Only\r\n                  \r\n                  OR\r\n                  ( -- All Corridor Conditions (1b, 2a, 2b)\r\n                    -- Common requirement to all corridor conditions (1b, 2a, 2c):\r\n                    -- Are the Truck and Load going in the same general direction\r\n                      \r\n                     ( (@uABx*(l.DestLong-l.SrceLong) + @uABy*(l.DestLat-l.SrceLat)) > 0 )\r\n                     AND\r\n                     ( -- all other conditions (1b, 2a, 2b)\r\n                        (-- 1b conditions:  Load source is in truck source Range Circle AND LDest is in truck's corridor \r\n                            -- 1b i.  Load Source Point in Truck Source Range Circle \r\n                            ( (@SrceLong <> 0.0 AND @SrceLong = l.SrceLong AND @SrceLat = l.SrceLat)\r\n                              OR\r\n                              (@SrceLong <> 0.0 AND  @SrceRadius >= dbo.udf_GetDistance( @SrceLat, @SrceLong, l.SrceLat, l.SrceLong)\r\n                              ) \r\n                        ) -- END of 1b i. condition\r\n                        AND\r\n                        ( -- 1b ii: LDest in truck's corridor  \r\n                          --  (The test point is the load point)\r\n                          --  Is the load DESTINATION point in the corridor?\r\n                          ( ( (@Nx - @Mx)*(l.DestLat - @My) - (l.DestLong - @Mx)*(@Ny - @My)  ) >= 0.00)  -- load source is left of MN\r\n                          AND\r\n                          ( ( (@Ox - @Nx)*(l.DestLat - @Ny) - (l.DestLong - @Nx)*(@Oy - @Ny)  ) >= 0.00)  -- load source is left of NO\r\n                          AND\r\n                          ( ( (@Px - @Ox)*(l.DestLat - @Oy) - (l.DestLong - @Ox)*(@Py - @Oy)  ) >= 0.00)  -- load source is left of OP\r\n                          AND\r\n                          ( ( (@Mx - @Px)*(l.DestLat - @Py) - (l.DestLong - @Px)*(@My - @Py)  ) >= 0.00)  -- load source is left of PM\r\n                        ) --...END of 1b ii. condition\r\n                        \r\n                     ) -- ......  END of 1b condition\r\n                     OR\r\n                     (  -- 2a and 2b Conditions\r\n                        -- 2a+b i. LSource in truck's Corridor \r\n                        (   ( ( (@Nx - @Mx)*(l.SrceLat - @My) - (l.SrceLong - @Mx)*(@Ny - @My)  ) >= 0.00)  -- load source is left of MN\r\n                            AND\r\n                            ( ( (@Ox - @Nx)*(l.SrceLat - @Ny) - (l.SrceLong - @Nx)*(@Oy - @Ny)  ) >= 0.00)  -- load source is left of NO\r\n                            AND\r\n                            ( ( (@Px - @Ox)*(l.SrceLat - @Oy) - (l.SrceLong - @Ox)*(@Py - @Oy)  ) >= 0.00)  -- load source is left of OP\r\n                            AND\r\n                            ( ( (@Mx - @Px)*(l.SrceLat - @Py) - (l.SrceLong - @Px)*(@My - @Py)  ) >= 0.00)  -- load source is left of PM\r\n                         \r\n                        ) -- END of 2a/b i condition.\r\n                        AND\r\n                        ( -- 2a ii OR 2b ii Conditions...................\r\n                            ( -- 2a ii. LDest in Truck's Dest Range Circle\r\n                               (@DestLong <> 0.0 AND @DestLong = l.DestLong AND @DestLat=l.DestLat)\r\n                               OR\r\n                               (@DestLong <> 0.0 AND @DestRadius >= dbo.udf_GetDistance( @DestLat, @DestLong, l.DestLat, l.DestLong)\r\n                               )\r\n                            ) -- END of 2a ii condition.\r\n                            OR\r\n                            ( -- 2b ii   LDest in Truck's Corridor.  \r\n                               ( ( (@Nx - @Mx)*(l.DestLat - @My) - (l.DestLong - @Mx)*(@Ny - @My)  ) >= 0.00)  -- load source is left of MN\r\n                               AND\r\n                               ( ( (@Ox - @Nx)*(l.DestLat - @Ny) - (l.DestLong - @Nx)*(@Oy - @Ny)  ) >= 0.00)  -- load source is left of NO\r\n                               AND\r\n                               ( ( (@Px - @Ox)*(l.DestLat - @Oy) - (l.DestLong - @Ox)*(@Py - @Oy)  ) >= 0.00)  -- load source is left of OP\r\n                               AND\r\n                               ( ( (@Mx - @Px)*(l.DestLat - @Py) - (l.DestLong - @Px)*(@My - @Py)  ) >= 0.00)  -- load source is left of PM\r\n                            ) -- END of 2b ii condition\r\n                                               ) -- END of 2a ii OR 2b ii conditions\r\n                         \r\n                     ) -- END of condition 2a and 2b\r\n                     \r\n                  )  -- END of 'All other corridor conditions\r\n                            \r\n               ) -- END of all corridor conditions.\r\n                   \r\n            ) -- END of GEOGRAPHIC conditions\r\n            \r\n       END -- .... END of Range Circle Plus Corridor Query\r\n    \r\n    -----------------------------------------------------------------------------------------------\r\n    -- start Range Circle (only) Query \r\n    -- If Corridor Matching is NOT chosen, just do RANGE circle tests\r\n    -- for all loads within the truck's specified source and destination range circles \r\n    -----------------------------------------------------------------------------------------------\r\n    ELSE     \r\n       BEGIN\r\n          --  This is with geographic condition \"1a\" only.\r\n          -- Insert equipment matches into the LinkEquipMatch table if they match.\r\n        INSERT INTO dbo.EquipmentLead\r\n    \t (\r\n    \t [CustCd] \r\n    \t,[EToken] \r\n    \t,[LToken]\r\n    \t,[CreatedOn]\r\n    \t,[CreatedBy]\r\n    \t,[LeadType]\r\n    \t)\r\n        SELECT @CustCd\r\n              ,@EquipToken\r\n              ,l.Token\r\n              ,@GetDate\r\n              ,@UserID\r\n    \t\t  ,@PrimaryMatch\r\n          FROM dbo.LoadPosting l \r\n    \r\n          -----------------------------------------------------------\r\n          -- Common lead filtering\r\n          -----------------------------------------------------------\r\n                 -- Available date matches\r\n          WHERE (l.DateAvail >= @DateAvail)\r\n  \r\n\t\t\t-- Vehicle size matches (Mask out only the first two bits - no corridor bit)\r\n\t\t\tAND ((@VSize & l.VSize & @AllVSize) > 0) \r\n        \r\n\t\t\t-- Vechicle Type match\r\n\t\t\tAND ((@VType & l.VType) > 0) \r\n    \r\n\t\t\t-- Posting Attribute match (Carrier)\r\n\t\t\t--Commented by Hiren on 04Jun19\r\n\t\t\t--AND ((@PAttrib & l.PAttrib) >= l.PAttrib) \r\n    \r\n\t\t\t-- Country Border restriction conditions for equipment\r\n\t\t\tAND (    \r\n\t\t\t\t\t\tl.SrceCountry = @SrceCountry   AND\r\n\t\t\t\t\t\tl.DestCountry = @DestCountry \r\n\t\t\t\t) -- .... END of country border closing tests\r\n           \r\n\t\t\t-- Used the Removed column instead of Removed table.\r\n\t\t\tAND (l.DeletedOn IS NULL)\r\n\r\n\t\t\t-- Check if Load Posting is Private Network \r\n\t\t\tAND (l.PostMode = 'A' OR (EXISTS(SELECT 'X' FROM dbo.NetworkMembers \r\n\t\t\t\t\t\t\t\t\t\t\t\t\tWHERE NetworkId = l.NetworkId \r\n\t\t\t\t\t\t\t\t\t\t\t\t\tAND MemberCustCD = @CustCd)))\r\n           \r\n\t\t\t-- Check if Equipment Posting is Private Network \r\n\t\t\tAND (@PostMode = 'A' OR (EXISTS(SELECT 'X' FROM dbo.NetworkMembers \r\n\t\t\t\t\t\t\t\t\t\t\t\t\tWHERE NetworkId = @NetworkId \r\n\t\t\t\t\t\t\t\t\t\t\t\t\tAND MemberCustCD = l.CustCd)))\r\n\r\n\t\t\t-- Posting Status has to be Open\r\n\t\t    AND (l.PStatus IN ('O','P'))\r\n        \r\n\t\t\t-- Source Point Conditions\r\n\t\t\tAND (  (@SrceLong <> 0.0 AND @SrceLong = l.SrceLong AND @SrceLat = l.SrceLat) \r\n\t\t\t\t\tOR\r\n\t\t\t\t\t(@SrceLong <> 0.0 AND  @SrceRadius >= dbo.udf_GetDistance( @SrceLat, @SrceLong, l.SrceLat, l.SrceLong)\r\n\t\t\t\t\t)       \r\n\t\t\t\t)\r\n    \r\n\t\t\t--Destination Point conditions\r\n\t\t\tAND (  (@DestLong <> 0.0 AND @DestLong = l.DestLong AND @DestLat=l.DestLat) \r\n\t\t\t\t\tOR\r\n\t\t\t\t\t(@DestLong <> 0.0 AND @DestRadius >= dbo.udf_GetDistance( @DestLat, @DestLong, l.DestLat, l.DestLong)\r\n\t\t\t\t\t)\r\n\t\t\t\t)\r\n\t\t\t\t\r\n\t\t\t-- Exclude matches from Globally-Excluded customers\r\n\t\t   AND (l.CustCd NOT IN (SELECT CustCd FROM Main.dbo.Account WHERE GlobalExcluded = 1))\r\n       END\r\n    END -- End @OriginalToken\r\n\r\n-----------------------------------------------------------------------------------------------\r\n-- PART 2 Insert Load matches for broker load posting\r\n-- ONLY DO THIS PART IF the CustCd is NOT in the GLOBAL excludes. -- Check once here\r\n--                      This will save in inserts and filtering later in getleads\r\n-----------------------------------------------------------------------------------------------\r\nIF (@GlobalExclude = 0)\r\n   BEGIN\r\n     INSERT INTO dbo.LoadLead\r\n\t(\r\n\t [CustCd] \r\n\t,[EToken] \r\n\t,[LToken]\r\n\t,[CreatedOn]\r\n\t,[CreatedBy]\r\n\t,[LeadType]\r\n\t)\r\n     SELECT l.CustCd\r\n           ,@EquipToken\r\n           ,l.Token\r\n           ,@GetDate\r\n\t\t   ,@UserID\r\n\t\t   ,@SecondaryMatch\r\n      FROM dbo.LoadPosting l \r\n      \r\n      -----------------------------------------------------------\r\n      -- Common lead filtering\r\n      -----------------------------------------------------------\r\n             -- Available date matches\r\n      WHERE (@DateAvail >= l.DateAvail)\r\n\r\n        -- Vehicle size matches\r\n        AND ((@VSize & l.VSize & @AllVSize) > 0) \r\n    \r\n        -- Vechicle Type match\r\n        AND ((@VType & l.VType) > 0) \r\n\r\n        -- Posting Attribute match (Carrier)\r\n\t\t--Commented By Hiren 04Jun19\r\n        --AND ((@PAttrib & l.PAttrib) >= l.PAttrib) \r\n\r\n        -- Country Border restriction conditions for equipment\r\n        AND (    \r\n                   l.SrceCountry = @SrceCountry   AND\r\n                   l.DestCountry = @DestCountry \r\n            ) -- .... END of country border closing tests\r\n\r\n       -- Used the Removed column instead of Removed table.\r\n       AND (l.DeletedOn IS NULL)\r\n\r\n       -- Source Point Conditions\r\n       AND (  (l.SrceLong <> 0.0 AND @SrceLong = l.SrceLong AND @SrceLat=l.SrceLat)\r\n              OR\r\n              (l.SrceLong <> 0.0 AND  l.SrceRadius >=  dbo.udf_GetDistance( @SrceLat, @SrceLong, l.SrceLat, l.SrceLong)\r\n              )     \r\n            )\r\n\r\n        -- Destination Point conditions\r\n       AND (  (l.DestLong <> 0.0 AND @DestLong = l.DestLong AND @DestLat = l.DestLat)\r\n              OR\r\n              (l.DestLong <> 0.0 AND l.DestRadius >= dbo.udf_GetDistance( @DestLat, @DestLong, l.DestLat, l.DestLong)\r\n              )\r\n            )\r\n\r\n       -- Check if Load Posting is Private Network \r\n       AND (l.PostMode = 'A' OR (EXISTS(SELECT 'X' FROM dbo.NetworkMembers \r\n                                                WHERE NetworkId = l.NetworkId \r\n                                                AND MemberCustCD = @CustCd)))\r\n\r\n       -- Check if Equipment Posting is Private Network \r\n       AND (@PostMode = 'A' OR (EXISTS(SELECT 'X' FROM dbo.NetworkMembers \r\n                                                WHERE NetworkId = @NetworkId \r\n                                                AND MemberCustCD = l.CustCd)))\r\n       -- Posting Status has to be Open\r\n       AND (l.PStatus = 'O')\r\n\r\n       -- Ignore Legacy Posting from Secondary (livelead) matching \r\n       AND (l.OriginalToken = 0)\r\n\r\n   END\r\n END","parameters":[{"name":"EquipToken","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"CustCd","description":null,"mode":"IN","data_type":"varchar(10)","custom_fields":{}},{"name":"UserID","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"SrceID","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"SrceSt","description":null,"mode":"IN","data_type":"char(2)","custom_fields":{}},{"name":"SrceLong","description":null,"mode":"IN","data_type":"float","custom_fields":{}},{"name":"SrceLat","description":null,"mode":"IN","data_type":"float","custom_fields":{}},{"name":"SrceCountry","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"SrceRadius","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"DestID","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"DestSt","description":null,"mode":"IN","data_type":"char(2)","custom_fields":{}},{"name":"DestLong","description":null,"mode":"IN","data_type":"float","custom_fields":{}},{"name":"DestLat","description":null,"mode":"IN","data_type":"float","custom_fields":{}},{"name":"DestCountry","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"DestRadius","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"DateAvail","description":null,"mode":"IN","data_type":"datetime","custom_fields":{}},{"name":"VSize","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"VType","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"PAttrib","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"PostMode","description":null,"mode":"IN","data_type":"char(1)","custom_fields":{}},{"name":"GlobalExclude","description":null,"mode":"IN","data_type":"bit","custom_fields":{}},{"name":"NetworkId","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"Corridor","description":null,"mode":"IN","data_type":"char(1)","custom_fields":{}},{"name":"OriginalToken","description":null,"mode":"IN","data_type":"int","custom_fields":{}}],"dependencies":null,"imported_at":"2021-07-29 12:59"};