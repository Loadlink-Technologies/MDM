window.repositoryObject = {"parameters_custom_fields":[],"object_id":"f181","name":"udf_GetLoadLeadsCount","subtype":"FUNCTION","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"LoadMatching@UDVLPLL4DATASRV.linklogi.com","id":"d9"}},{"field":"Schema","value":"dbo"},{"field":"Name","value":"udf_GetLoadLeadsCount"},{"field":"Type","value":"Function"}],"script":"CREATE FUNCTION [dbo].[udf_GetLoadLeadsCount](\r\n   @CustCD Varchar(10)     \r\n , @LToken\tINT \r\n , @GetDAT\tBIT \r\n )\r\n RETURNS INT\r\n  \r\nAS\r\n--------------------------------------------------------------------------\r\n--FUNCTION NAME : [udf_GetLoadLeadsCount]\r\n--------------------------------------------------------------------------\r\n-- DESCRIPTION    : Get Load Leads count for the posting\r\n--\r\n-- CALLED BY      : usp_GetEquipmentPosting SP \r\n--\r\n-- INPUT PARAMS   : @UserID     - Caller UserID\r\n--                  @LToken     - Load Token is pass if retrieving the Leads Count for 1 Load Posting         \r\n--                  @GetDAT     - flag to include DAT Leads count or not (should not include DAT count if not subscribed to DAT feature)      \r\n--------------------------------------------------------------------------\r\n-- HISTORY : \r\n-- AUTHOR    DATE\t\t\tDESCRIPTION\r\n-- Nesrin   2020.03.05      LLSIM-3998: Create new function to return leads count\r\n--                          Return the leads count with the Load posting list\r\n-- Nesrin    2020.04.14\t\tLLSIM-4061: Script current Loadmatching DB \r\n--\t\t\t\t\t\t\tand create a new one with no memory optimized tables\r\n--------------------------------------------------------------------------\r\nBEGIN\r\n\r\nDeclare @LeadsCount INT = 0\r\n\r\n\r\nIF (@GetDAT = 1)\r\n\tBEGIN\r\n\t\tSELECT\t@LeadsCount = SUM(LeadCount)  FROM\r\n\t\t(\r\n\t\t\t-- LOAD LEADS\r\n\t\t\t\tSELECT\t COUNT(*) LeadCount\r\n\t\t\t\t\t\tFROM\tdbo.LoadLead LL WITH(NOLOCK)\r\n\t\t\t\t\t\t\t\tINNER JOIN dbo.EquipmentPosting E WITH(NOLOCK) ON LL.EToken = E.Token\r\n\t\t\t\t\t\tWHERE\tLL.LToken = @LToken  \r\n\t\t\t\t\t\t\t\tAND (E.DeletedOn IS NULL)\r\n\t\t\t\t\t\t\t\tAND  E.PStatus = 'O' -- Open\r\n\t\t\t\t\t\t\t\tAND (NOT EXISTS ( SELECT 'X' FROM dbo.Exclude x WITH(NOLOCK) WHERE x.CustCd = @CustCd  AND x.ExcludeCustCd = E.CustCd) ) \r\n\t\t\t\t\t\t\t\tAND (NOT EXISTS ( SELECT 'X' FROM dbo.Exclude x WITH(NOLOCK) WHERE x.CustCd = E.CustCd AND x.ExcludeCustCd = @CustCd ) ) \r\n\t\t\t\t\t\t\t\t--AND LL.LeadType <> 'S' \t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\tUNION ALL\r\n\t \r\n\t\t\t-- DAT LOAD LEADS\r\n\t\t\t\tSELECT\t COUNT(*) LeadCount\r\n\t\t\t\t\t\tFROM\tdbo.DATLoadLead LL WITH(NOLOCK)\r\n\t\t\t\t\t\t\t\tINNER JOIN dbo.DATEquipmentPosting E WITH(NOLOCK) ON LL.EToken = E.Token\r\n\t\t\t\t\t\tWHERE\tLL.LToken = @LToken  \r\n\t\t\t\t\t\t\t\tAND (E.DeletedOn IS NULL)\r\n\t\t\t\t\t\t\t\tAND (NOT EXISTS ( SELECT 'X' FROM dbo.Exclude x WITH(NOLOCK) WHERE x.CustCd = @CustCd  AND x.ExcludeCustCd = E.CustCd) ) \r\n\t\t\t\t\t\t\t\tAND (NOT EXISTS ( SELECT 'X' FROM dbo.Exclude x WITH(NOLOCK) WHERE x.CustCd = E.CustCd AND x.ExcludeCustCd = @CustCd ) ) \r\n\t\t\t\t\t\t\t\t--AND LL.LeadType <> 'S'\r\n\t\t\t\t) A\r\n\r\n\t\r\n\t\t\r\n\t\t\tRETURN @LeadsCount \r\n\tEND\r\n\r\nELSE\r\n\tBEGIN\r\n\t\tSELECT\t@LeadsCount = COUNT(*)\r\n\t\t\t\t\tFROM\tdbo.LoadLead LL WITH(NOLOCK)\r\n\t\t\t\t\t\t\tINNER JOIN dbo.EquipmentPosting E WITH(NOLOCK) ON LL.EToken = E.Token\r\n\t\t\t\t\tWHERE\tLL.LToken = @LToken  \r\n\t\t\t\t\t\t\tAND (E.DeletedOn IS NULL)\r\n\t\t\t\t\t\t\tAND  E.PStatus = 'O' -- Open\r\n\t\t\t\t\t\t\tAND (NOT EXISTS ( SELECT 'X' FROM dbo.Exclude x WITH(NOLOCK) WHERE x.CustCd = @CustCd  AND x.ExcludeCustCd = E.CustCd) ) \r\n\t\t\t\t\t\t\tAND (NOT EXISTS ( SELECT 'X' FROM dbo.Exclude x WITH(NOLOCK) WHERE x.CustCd = E.CustCd AND x.ExcludeCustCd = @CustCd ) )  \r\n\t\t\t\t\t\t\t--AND LL.LeadType <> 'S'\r\n\t END\r\n\tRETURN @LeadsCount\t\t\t\t\r\nEND","parameters":[{"name":"Returns","description":null,"mode":"OUT","data_type":"int","custom_fields":{}},{"name":"CustCD","description":null,"mode":"IN","data_type":"varchar(10)","custom_fields":{}},{"name":"LToken","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"GetDAT","description":null,"mode":"IN","data_type":"bit","custom_fields":{}}],"dependencies":null,"imported_at":"2021-07-29 12:59"};