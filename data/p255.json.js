window.repositoryObject = {"parameters_custom_fields":[],"object_id":"p255","name":"usp_GetEquipmentLead_Vev","subtype":"PROCEDURE","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"LoadMatching@UDVLPLL4DATASRV.linklogi.com","id":"d9"}},{"field":"Schema","value":"dbo"},{"field":"Name","value":"usp_GetEquipmentLead_Vev"},{"field":"Type","value":"Procedure"}],"script":"CREATE PROCEDURE [dbo].[usp_GetEquipmentLead_Vev] \r\n  --@UserID           int         \r\n  @CustCD\t\t\tVARCHAR(10)\r\n ,@EToken           INT = 0\r\n ,@ServerName       VARCHAR(75) = '' \r\n ,@Version          VARCHAR(50) = 'V4.00'\r\n ,@MileageProvider  CHAR(1) = 'P' -- G=Google (Default), P=PCMiler \r\n ,@LeadFrom         DATETIME2 = NULL\r\n ,@LeadsCap\t\t\tINT = 0\r\n \r\n--------------------------------------------------------------------------\r\n--PROCEDURE NAME : usp_GetEquipmentLead\r\n--------------------------------------------------------------------------\r\n-- DESCRIPTION    : Get Equipoment Lead for the Users\r\n--\r\n-- CALLED BY      : LoadMatching Web API \r\n-- EXECUTION FREQUENCY : \r\n-- \r\n-- INPUT PARAMS   : @CustCD             - Caller CustCD\r\n--                  @EToken             - Equipment Token is pass if retrieving the Lead for 1 Equipment Posting         \r\n--                  @ServerName         - Name of Web Server where the request is coming from \r\n--                  @Version            - Version of calling Client\r\n--                  @MileageProvider    - Mileage Engine Provider, G=Google(Default), P=PCMiler\r\n--                  @LeadFrom           - If null, then return all avilable lead, otherwise return any lead newer than @LeadFrom \r\n--\t\t\t\t\t@LeadsCap\t\t\t- Optional. if 0 return ALL Leads, and if >0 = Cap leads to this value.\r\n--                 \r\n-- OUTPUT PARAMS  :\r\n-- STATUS RETURN  : \r\n-----------------------------------------------------------------------------------------------------------------------------------------------\r\n-- HISTORY : \r\n-- AUTHOR    DATE\t\t\tDESCRIPTION\r\n-- Hiro      2018.01.30     Initial Development\r\n-- Hiro      2018.04.11     Added Contacted\r\n-- Hiro      2018.04.18     Added Financial index (Equifax, Transcredit Canada, and Transcredit US) \r\n-- Vevian    2018.05.24     Added (QPStatus) new column value from FinanceIndex table (instead of statis 'Y' value) - JIRA ticket LLSIM-550\r\n-- Hiro      2018.07.06     Added @LeadFrom DateTime parameter for LiveLead functionality.\r\n-- Vevian\t 2018.07.30     Added Excluded value based on new table \"Exclude\"\r\n-- Hiro      2018.07.31     Modifed the Excluded logic to Hide Your lead from Excluded Customer and Excluded their lead from you. \r\n-- Hiro      2018.08.08     Added Flag value based on Flag Table\r\n-- Hiro      2018.09.06     Added SubscriberType to identify: Link-P (Platform), Link-L (Legacy), DAT\r\n-- Hiro      2018.10.30     LiveLead mode (@LeadFrom <> null) only return Secondary Match (LLSIM-1604)\r\n-- Hiro      2018.12.05     Added ISNULL check to SubscriberType and QuickPay to prevent issue with Mobile (LLSIM-1663)\r\n-- Nesrin    2019.03.08     LLSIM-1758: Change the Default value of @MileageProvider to P to get the PCMilerMiles\r\n-- Nesrin    2019.05.22     LLSIM-2718: Update the stored procedure to retrieve the missing values for customers (Phone & Email) as done to DAT  \r\n-- Nesrin    2019.06.13     LLSIM-2884: Fix Live Leads to get the Leads posted within the provided time stamp range\r\n--                          For the live leads, the query was checking the CreatedOn value of EquipmentLeads (Matching date) and not the value in \r\n--                          LoadPosting (actual date the posted is created)  \r\n-- Vevian    2019.06.25     LLSIM-2951: for Live Leads, only return up to 150 leads +\r\n--\t\t\t\t\t\t\tSort the returned leads (all leads) starting with the latest \r\n-- Vevian    2019.06.27     LLSIM-2962: change @UserID parameter to @CustCD since CustCD is needed for the logic here not UserID\r\n--\t\t\t\t\t\t\t\t\t\tNo need to use (dbo.udf_GetCustCd) function anymore in this case\r\n--\t\t\t\t\t\t\t\t\t\t+ return new value posting Type (PType) - 'L' for Load & 'E' for Equipment\r\n-- Vevian\t 2019.07.03\t\tLLSIM-2989: Return the proper contacted value (fix conditions in the Left Join with Contacted table)\r\n-- Nesrin    2019.11.18     LLSIM-3631: Update the SP usp_GetEquipmentLead to return 0 value for Customer Tracking\r\n-- Nesrin    2020.01.14     LLSIM-3794: Customers are not seeing Live Leads (some Carriers)\r\n-- Nesrin    2020.02.11     LLSIM-3933: Update GETEquipmentLead sp to display correct value of Equifax score\r\n--                                      If the value is 0 --> display as 0 instead of -1\r\n-- Nesrin   2020.02.27      LLSIM-3974: SP code changes \r\n-- Vevian   2020.02.27      Performance issue for LLW4 (Add nolock, drop temp table, Add leads capping)\r\n-- Nesrin   2020.03.05\t\tLLSIM-4001: Optimize the code for all leads stored procedures \r\n-- John\t\t2020.03.09\t\tLLSIM-4001 - optimization and refactor\r\n-- Vevian\t2020.03.20\t\tLLSIM-4046: add optional parameter \"LeadsCap\"\r\n--\t\t\t\t\t\t\t\t\t\t0 = ALL Leads, >0 = Cap leads to this value.\r\n-- Vevian\t2020.04.09\t\tLLSIM-4061: Code optimization after converting memory-optimized tables to Desk-based tables\r\n----------------------------------------------------------------------------------------------------------------------------------------------------\r\nAS\r\n\r\nBEGIN\r\n\r\n\tSET NOCOUNT ON\t\r\n\r\n\tDECLARE @LiveCall BIT = 1 -- 1=Live , 0=Non-Live\r\n\tDECLARE @CustomerTracking BIT = 0\r\n\tDECLARE @defaultDisplayCount AS INT = 150 -- set default count for livelead\r\n\r\n\tIF (@LeadFrom IS NULL)\r\n\tBEGIN\r\n\t\t-- changed variable initialization from SELECT to SET\r\n\t\tSET @LeadFrom = '1997-01-01 00:00:00:000'\r\n\t\tSET @LiveCall = 0\r\n\t\t--SET @defaultDisplayCount = 0 -- 0 show all rows\r\n\t\tSET @defaultDisplayCount = @LeadsCap\t-- default 0 to show all rows\r\n\tEND\r\n\r\n\tSET ROWCOUNT @defaultDisplayCount -- set total number of rows to return \r\n\r\n\tSELECT \r\n\t\tL.CustCD ,\r\n\t\tL.DateAvail ,\r\n\r\n\t\tL.SrceID ,\r\n\t\tL.SrceCity ,\r\n\t\tL.SrceSt ,\r\n\t\tL.SrceCountry ,\r\n\t\tL.SrceLong ,\r\n\t\tL.SrceLat ,\r\n\r\n\t\tL.DestID ,\r\n\t\tL.DestCity ,\r\n\t\tL.DestSt ,\r\n\t\tL.DestCountry ,\r\n\t\tL.DestLong ,\r\n\t\tL.DestLat ,\r\n\t\tvs.Code VehicleSize, -- eliminate function call to avoid repeated table scans\r\n\t\tdbo.udf_VTypeToString(L.VType) VehicleType ,\r\n\t\tL.Comment ,\r\n\t\tL.PostMode ,\r\n\t\tL.ClientRefNum ,\r\n\t\tL.ProductName ,\r\n\t\tdbo.udf_PostingAttributeToString(L.PAttrib) PostingAttrib ,\r\n\t\tdbo.udf_GetMileage(L.SrceID, L.DestID, @MileageProvider) Distance,\r\n\t\t--dbo.udf_GetMileage_Vev(L.SrceID, L.DestID, @MileageProvider) Distance,\r\n\t\tL.Token      LToken ,\r\n\t\tE.Token      EToken ,\r\n\t\tL.CreatedBy ,\r\n\t\tL.CreatedOn ,\r\n\t\tL.DeletedBy ,\r\n\t\tL.DeletedOn ,\r\n\t\t-- Here are the list of hardcoded field until requirement is finilized.\r\n\t\tISNULL(A.CommonName,'NA') Company ,\r\n\t\tISNULL(A.Phone,'NA') Phone,\r\n\t\tISNULL(A.Email,'NA') Email,\r\n\t\tISNULL(Idx.QPStatus,0) QPStatus ,\r\n\t\tISNULL(Idx.Equifax_PAYMNTINDX ,-1) Equifax,\r\n\t\tISNULL(Idx.TranscreditCA_Analysis,-1) TCC ,\r\n\t\t-1 TCUS ,\r\n\t\tdbo.udf_DestDirection (E.SrceLong, E.SrceLat, L.SrceLong, L.SrceLat) DirO ,\r\n\t\tdbo.udf_GetMileage(E.SrceID, L.SrceID, @MileageProvider) DFO ,\r\n\t\tdbo.udf_GetMileage(E.DestID, L.DestID, @MileageProvider) DFD ,\t\t\r\n\t\t--dbo.udf_GetMileage_Vev(E.SrceID, L.SrceID, @MileageProvider) DFO ,\r\n\t\t--dbo.udf_GetMileage_Vev(E.DestID, L.DestID, @MileageProvider) DFD ,\r\n\t\tIIF(Cn.LToken IS NULL,'', 'Y') Contacted, -- since we only have one case, it is more syntatically and cleaner to use IIF vs CASE\r\n\t\tIIF(F.ContactCustCd IS NULL,0, F.Id) Flag, -- since we only have one case, it is more syntatically and cleaner to use IIF vs CASE\r\n\t\tISNULL(A.SubscriberType,'NA') SubscriberType,\r\n\t\t'L' PType,\r\n\t\t@CustomerTracking AS  CustomerTracking\r\n\tFROM dbo.EquipmentLead EL WITH(NOLOCK)\r\n\t\tINNER JOIN\tdbo.LoadPosting L WITH(NOLOCK) ON EL.LToken=L.Token\r\n\t\tINNER JOIN\tdbo.EquipmentPosting E WITH(NOLOCK) ON EL.EToken=E.Token\r\n\t\tINNER JOIN\tdbo.VehicleSize vs ON L.VSize = vs.Value AND vs.PostType = 'L'\r\n\t\tINNER JOIN\tMain.dbo.Account A WITH(NOLOCK) ON A.CustCD = L.CustCd\r\n\t\tLEFT JOIN\tdbo.Contacted Cn WITH(NOLOCK) ON (Cn.EToken = 0 AND Cn.LToken = EL.LToken AND Cn.CustCd = E.CustCd AND Cn.CnCustCd = L.CustCd)\r\n\t\tLEFT JOIN\tdbo.Flag F WITH(NOLOCK) ON (F.EToken = EL.EToken AND F.LToken = EL.LToken AND F.CustCd = E.CustCd AND F.ContactCustCd = L.CustCd)\r\n\t\t-- Once Account information is accessible Contacted and Finance Index will be returned\r\n\t\tLEFT JOIN\tFinance.dbo.FinanceIndex  Idx WITH(NOLOCK) on Idx.CustCD = L.CustCD \r\n\tWHERE E.CustCd = @CustCd\r\n\t\tAND (@EToken = 0 OR @EToken = E.Token)\r\n\t\tAND (E.DeletedOn IS NULL)\r\n\t\tAND (L.DeletedOn IS NULL)\r\n\t\tAND  L.PStatus in('O','P') -- Open\r\n\t\tAND (L.CreatedOn > @LeadFrom)\r\n\t\tAND (NOT EXISTS ( SELECT 1 FROM Exclude x  WITH(NOLOCK) WHERE x.CustCd = @CustCd  AND x.ExcludeCustCd = L.CustCd) ) \r\n\t\tAND (NOT EXISTS ( SELECT 1 FROM Exclude x  WITH(NOLOCK) WHERE x.CustCd = L.CustCd AND x.ExcludeCustCd = @CustCd ) ) \r\n\t\tAND (@LiveCall = 0 OR EL.LeadType = 'S') -- In LiveLead only return the secondary match lead.\r\n\tORDER BY CreatedOn DESC\r\n\r\n\tSET ROWCOUNT 0 -- reset \r\n\r\nEND","parameters":[{"name":"CustCD","description":null,"mode":"IN","data_type":"varchar(10)","custom_fields":{}},{"name":"EToken","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"ServerName","description":null,"mode":"IN","data_type":"varchar(75)","custom_fields":{}},{"name":"Version","description":null,"mode":"IN","data_type":"varchar(50)","custom_fields":{}},{"name":"MileageProvider","description":null,"mode":"IN","data_type":"char(1)","custom_fields":{}},{"name":"LeadFrom","description":null,"mode":"IN","data_type":"datetime2(7)","custom_fields":{}},{"name":"LeadsCap","description":null,"mode":"IN","data_type":"int","custom_fields":{}}],"dependencies":null,"imported_at":"2021-07-29 12:59"};