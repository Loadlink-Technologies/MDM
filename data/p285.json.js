window.repositoryObject = {"parameters_custom_fields":[],"object_id":"p285","name":"usp_GetNetworkMemberList","subtype":"PROCEDURE","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"LoadMatching@UDVLPLL4DATASRV.linklogi.com","id":"d9"}},{"field":"Schema","value":"dbo"},{"field":"Name","value":"usp_GetNetworkMemberList"},{"field":"Type","value":"Procedure"}],"script":"CREATE PROCEDURE [dbo].[usp_GetNetworkMemberList]\r\n(\r\n\t@CustCd varchar(10),\r\n\t@NetworkId int = null\r\n)\r\n-- ======================================================================================================================\r\n-- Author:          Create date     Description:\t\r\n-- Kruti Chokshi    08.22.2017      Get list of network and associated carries/company for given user\r\n-- Hiro Maeda       01.30.2018      Changed the Platform database to Main\r\n-- Kruti Chokshi    05.01.2018      Bug Fix: Pull data by CUSTCD and not USERID\r\n-- Nesrin\t\t\t04.02.2019\t\t[LLSIM-2541]: As a Flagged user, I am unable to add a flagged company to a Network\r\n-- Vevian\t\t\t2020.04.13\t\tLLSIM-4061: some Code optimization after converting memory-optimized tables to Desk-based tables\r\n-- =======================================================================================================================\t\r\nAS\r\n\tDECLARE @UserMembers TABLE\r\n\t(\r\n\t\tId INT ,\r\n\t\tNetworkId INT,\r\n\t\tMemberCustCD VARCHAR(10)\r\n\t) \r\n\r\n\tDECLARE @counter int = 1\r\n\r\n\tDECLARE @Id INT\r\n\tDECLARE @AccountId INT\r\n\tDECLARE @MemberCustCD VARCHAR(10)\r\n\tDECLARE @RegisteredName VARCHAR(100)\r\n\tDECLARE @CommonName VARCHAR(100)\r\n\tDECLARE @CompanyPhone VARCHAR(100)\r\n\tDECLARE @CompanyLocation VARCHAR(100)\r\n\tDECLARE @ContactPhone VARCHAR(100)\r\n\tDECLARE @PrimaryContactName VARCHAR(100)\r\n\r\n\t-- Fetch records into variable table\r\n\tINSERT INTO @UserMembers (Id, NetworkId, MemberCustCD)\r\n\t\tSELECT \r\n\t\t\t nm.Id\r\n\t\t\t,nm.NetworkId\r\n\t\t\t,nm.MemberCustCD\r\n\t\tFROM \r\n\t\t\tNetworkMembers nm JOIN Networks n ON nm.NetworkId = n.Id\r\n\t\tWHERE \r\n\t\t\tn.CustCD =  @CustCd\r\n\t\t\tAND (nm.networkId = @NetworkId or @NetworkId IS NULL)\r\n\r\n\r\n\tSELECT\tCUS.* INTO #CUSTempt \r\n\tFROM\tdbo.DatCustomer CUS\r\n\t\t\tINNER JOIN @UserMembers um ON CUS.CustCD = um.MemberCustCD\r\n  \r\n       \r\n\tSELECT\tACC.* INTO #ACCTempt\r\n\tFROM\tMain.dbo.Account ACC \r\n\t\t\tINNER JOIN @UserMembers um ON ACC.CustCD = um.MemberCustCD \r\n\r\n\r\n\t-- Get Network, Company and account Data\r\n\tSELECT\r\n\t\tum.Id as Id,\r\n\t\tum.NetworkId as NetworkId,\r\n\t\tum.MemberCustCD as MemberCustCD,\r\n\t\tIIF(A.RegisteredName IS NULL, XMT_NAME, A.RegisteredName) AS RegisteredName,\r\n\t\tIIF(A.CommonName IS NULL, XMT_NAME, A.CommonName) AS CommonName,\r\n\t\tIIF(a.Phone IS NULL, XMT_PH1, a.Phone) AS CompanyPhone,\r\n\t\tIIF((ISNULL(c.MailingCity,'') + ' ' + ISNULL(c.MailingProvince,''))  = ''\r\n\t\t\t, CUST.CITY +', ' + CUST.HOMEPROV\r\n\t\t\t, ISNULL(c.MailingCity,'') + ' ' + ISNULL(c.MailingProvince,'')) AS CompanyLocation,\r\n\t\tIIF(c.Phone IS NULL, XMT_PHONE, C.Phone) AS ContactPhone,\t\r\n\t\tIIF((ISNULL(U.FirstName,'') + ' ' + ISNULL(U.LastName, ''))='', FIRST_NAME + ' ' + LAST_NAME, ISNULL(U.FirstName + ' ' + U.LastName, '')) AS PrimaryContactName\r\n\r\n\tFROM @UserMembers um\t\r\n\t\tLEFT JOIN\r\n\t\t\t #ACCTempt a ON  um.MemberCustCD = a.CustCD\r\n\t\tLEFT JOIN \r\n\t\t\t#CUSTempt CUST ON    um.MemberCustCD= CUST.CustCD \r\n \t\tleft JOIN \r\n\t\t\tMain.dbo.Contact c ON a.AccountId = c.AccountId and c.ContactType = 'Primary'\r\n\t\tLEFT JOIN \r\n\t\t\tMain.dbo.Users U   ON c.UserId = u.UserId\r\n\r\n-- Cleanup\r\nDROP TABLE #CUSTempt;\r\nDROP TABLE #ACCTempt;","parameters":[{"name":"CustCd","description":null,"mode":"IN","data_type":"varchar(10)","custom_fields":{}},{"name":"NetworkId","description":null,"mode":"IN","data_type":"int","custom_fields":{}}],"dependencies":null,"imported_at":"2021-07-29 12:59"};