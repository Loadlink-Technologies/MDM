window.repositoryObject = {"parameters_custom_fields":[],"object_id":"p199","name":"usp_CleanPostings","subtype":"PROCEDURE","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"LoadMatching@UDVLPLL4DATASRV.linklogi.com","id":"d9"}},{"field":"Schema","value":"dbo"},{"field":"Name","value":"usp_CleanPostings"},{"field":"Type","value":"Procedure"}],"script":"CREATE PROCEDURE [dbo].[usp_CleanPostings]\r\n-- =============================================================================================================\r\n-- Sergey\t25 Sep 2018\t\tInitial Development\r\n-- Nesrin   23 Dec 2019     LLSIM-3729: Update the Cleanup SP to include the new equipmentPostingCorridor table \r\n-- Vevian\t26 May 2021\t\tLL4RW-384: cleanup new postings with LiveLeads tables\r\n-- ==============================================================================================================\r\nAS\r\nBEGIN\r\n\r\n\tSET NOCOUNT ON;\r\n \r\n\tDECLARE @r INT, @TodayDate DATE;\r\n\tSELECT @TodayDate = CAST(GETDATE() AS DATE);\r\n\t--SET TRANSACTION ISOLATION LEVEL SERIALIZABLE \r\n \r\n    -- 1. Delete the Corridor values for the Expired Equipment Postings \r\n\tDELETE FROM [dbo].[EquipmentPostingCorridor]  WHERE Token IN (SELECT Token from  [dbo].[EquipmentPosting] WHERE DateAvail < @TodayDate)\r\n\t\r\n\t-- 2. Delete Removed Posting (DeletedOn <> NULL) in LoadPosting, EquipmentPosting, DATLoadPosting, and DATEquipmentPosting    \r\n\tDELETE FROM [dbo].[EquipmentPosting] WHERE DeletedOn IS NOT NULL \r\n\tDELETE FROM [dbo].[LoadPosting]  WHERE DeletedOn IS NOT NULL \r\n\tDELETE FROM [dbo].[DATEquipmentPosting]  WHERE DeletedOn IS NOT NULL \r\n\tDELETE FROM [dbo].[DATLoadPosting]  WHERE DeletedOn IS NOT NULL \r\n\r\n\t-- 3. Delete Expired Posting (DateAvail < Today) from Legacy(OriginalToken <> 0) and DAT (Check Enddate < Now or DateAvail < Today)\r\n\tDELETE FROM [dbo].[EquipmentPosting] WHERE OriginalToken <> 0 AND DateAvail < @TodayDate\r\n\tDELETE FROM [dbo].[LoadPosting] WHERE OriginalToken <> 0 AND DateAvail < @TodayDate\r\n\tDELETE FROM [dbo].[DATEquipmentPosting]  WHERE EndDate < GETDATE() OR DateAvail < @TodayDate\r\n\tDELETE FROM [dbo].[DATLoadPosting] WHERE EndDate < GETDATE() OR DateAvail < @TodayDate \r\n\r\n\t-- 4. Delete Expired Lead in LoadLead, EquipmentLead, DATLoadLead, and DATEquipmentLead. If EToken or LToken is invalid then delete. \r\n \tDELETE ll FROM LoadLead AS ll\r\n\tLEFT JOIN [LoadPosting] AS lp  ON ll.LToken = lp.Token\r\n\tLEFT JOIN [EquipmentPosting] AS ep  ON ll.EToken = ep.Token\r\n\tWHERE lp.Token IS NULL OR ep.Token IS NULL\r\n\r\n \tDELETE el FROM EquipmentLead AS el \r\n\tLEFT JOIN [LoadPosting] AS lp  ON el.LToken = lp.Token\r\n\tLEFT JOIN [EquipmentPosting] AS ep  ON el.EToken = ep.Token\r\n\tWHERE lp.Token IS NULL OR ep.Token IS NULL\r\n\r\n \tDELETE ll FROM DATLoadLead AS ll \r\n\tLEFT JOIN [DATLoadPosting] AS lp  ON ll.LToken = lp.Token\r\n\tLEFT JOIN [DATEquipmentPosting] AS ep  ON ll.EToken = ep.Token\r\n\tWHERE lp.Token IS NULL OR ep.Token IS NULL\r\n\r\n \tDELETE el FROM DATEquipmentLead AS el \r\n\tLEFT JOIN [DATLoadPosting] AS lp  ON el.LToken = lp.Token\r\n\tLEFT JOIN [DATEquipmentPosting] AS ep  ON el.EToken = ep.Token\r\n\tWHERE lp.Token IS NULL OR ep.Token IS NULL\r\n\r\n\t-- 5. Delete Expired Contacted (LToken or EToken is invalid)\r\n\tDELETE c FROM Contacted AS c\r\n\tLEFT JOIN [LoadPosting] AS l  ON c.LToken = l.Token\r\n\tLEFT JOIN [EquipmentPosting] AS e  ON c.EToken = e.Token\r\n\tWHERE (l.Token IS NULL AND LToken <> 0) OR (e.Token IS NULL AND EToken <> 0)\r\n\t\r\n\t-- 6. Mark the Expired(DateAvail < Today) Platform Posting's PStatus='E' <-- New PostingStatus to be inserted. \r\n\tUPDATE [dbo].[EquipmentPosting]  SET PStatus = 'E' WHERE OriginalToken = 0 AND DateAvail < @TodayDate AND PStatus = 'O'\r\n\tUPDATE [dbo].[LoadPosting]  SET PStatus = 'E' WHERE OriginalToken = 0 AND DateAvail < @TodayDate AND PStatus = 'O'\r\n\r\n\t-- 7. Cleanup data in new tables (EquipmentWLiveLeads & LoadsWLiveLeads)\r\n\tDELETE FROM [dbo].[LoadsWLiveLeads]\r\n\tDELETE FROM [dbo].[EquipmentWLiveLeads]\r\n\t\r\nEND","parameters":[],"dependencies":null,"imported_at":"2021-07-29 12:59"};