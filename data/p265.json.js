window.repositoryObject = {"parameters_custom_fields":[],"object_id":"p265","name":"usp_GetFlagList","subtype":"PROCEDURE","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"LoadMatching@UDVLPLL4DATASRV.linklogi.com","id":"d9"}},{"field":"Schema","value":"dbo"},{"field":"Name","value":"usp_GetFlagList"},{"field":"Type","value":"Procedure"}],"script":"CREATE PROCEDURE [dbo].[usp_GetFlagList] \r\n    @CustCD VARCHAR(10)           \r\n\r\n--------------------------------------------------------------------------\r\n--PROCEDURE NAME : usp_GetFlagList\r\n--------------------------------------------------------------------------\r\n-- DESCRIPTION    : Get flag list for customer\r\n--\r\n-- CALLED BY      : LoadMatching Web API \r\n-- EXECUTION FREQUENCY : \r\n-- \r\n-- INPUT PARAMS   : @CustCd caller's CUSTCD\r\n--                 \r\n-- OUTPUT PARAMS  :\r\n-- STATUS RETURN  : \r\n--------------------------------------------------------------------------\r\n-- HISTORY : \r\n-- AUTHOR    DATE       DESCRIPTION\r\n-- Hiro      2018.08.08 Initial Development\r\n-- Jatinder  2019.03.26 LLSIM-2524 - As a flag user, the web API should return subscriber type from the back end\r\n-- Rajesh    2019.03.28 LLSIM-2527 - DAT lead is not flaged as its account data is coming from DATCustomer table\r\n-- Nikhil\t 2019.07.15 LLSIM-3007 - Fix for Multiple cards returned in the Flagged section of the LoadLinkWeb4. Added 'DISTINCT' on #CUSTempt & #ACCTempt\r\n-- Vevian\t 2020.04.13\tLLSIM-4061: some Code optimization after converting memory-optimized tables to Desk-based tables\r\n-- Rajesh\t 2021.04.28 LL4RW-294 -  Flag contact name phone number fax number is not always displayed although it is available in the Finance contact tab, read contact for legacy\r\n--------------------------------------------------------------------------\r\nAS\r\nSET NOCOUNT ON;\r\n\r\nDECLARE @subType varchar(5);\r\n\r\nDECLARE @FlagInfo  TABLE\r\n(\r\n    [Id] [int],\r\n    [CustCd] [varchar](10) ,\r\n    [ContactCustCd] [varchar](10),\r\n    [LToken] [int],\r\n    [EToken] [int],\r\n    [LSrcCity] [varchar](50) ,\r\n    [LSrcSt] [varchar](2) ,\r\n    [LDestCity] [varchar](50) ,\r\n    [LDestSt] [varchar](2) ,\r\n    [LVType] [varchar](50) ,\r\n    [LVSize] [varchar](50) ,\r\n    [LPostedDate] [datetime2](7),\r\n    [LPAttrib] [varchar](20) ,\r\n    [LComment] [varchar](4096),\r\n    [PSrcCity] [varchar](50) ,\r\n    [PSrcSt] [varchar](2) ,\r\n    [PDestCity] [varchar](50) ,\r\n    [PDestSt] [varchar](2) ,\r\n    [PVType] [varchar](50) ,\r\n    [PVSize] [varchar](50) ,\r\n    [PPostedDate] [datetime2](7),\r\n    [PPAttrib] [varchar](50),\r\n    [PComment] [varchar](4096),\r\n    [PostType] [CHAR](1),\r\n    [CreatedOn] [datetime2](7) ,\r\n    [CreatedBy] [int] \r\n);\r\n\r\nINSERT INTO @FlagInfo (\r\n        Id\r\n        ,CustCD       \r\n        ,ContactCustCD\r\n        ,LToken       \r\n        ,EToken       \r\n        ,LSrcCity     \r\n        ,LSrcSt       \r\n        ,LDestCity    \r\n        ,LDestSt      \r\n        ,LVType       \r\n        ,LVSize       \r\n        ,LPostedDate  \r\n        ,LPAttrib     \r\n        ,LComment     \r\n        ,PSrcCity     \r\n        ,PSrcSt       \r\n        ,PDestCity    \r\n        ,PDestSt      \r\n        ,PVType       \r\n        ,PVSize       \r\n        ,PPostedDate  \r\n        ,PPAttrib     \r\n        ,PComment     \r\n        ,PostType     \r\n        ,CreatedBy \r\n        ,CreatedOn  \r\n)\r\n    SELECT\r\n        Id\r\n        ,CustCD       \r\n        ,ContactCustCD\r\n        ,LToken       \r\n        ,EToken       \r\n        ,LSrcCity     \r\n        ,LSrcSt       \r\n        ,LDestCity    \r\n        ,LDestSt      \r\n        ,LVType       \r\n        ,LVSize       \r\n        ,LPostedDate  \r\n        ,LPAttrib     \r\n        ,LComment     \r\n        ,PSrcCity     \r\n        ,PSrcSt       \r\n        ,PDestCity    \r\n        ,PDestSt      \r\n        ,PVType       \r\n        ,PVSize       \r\n        ,PPostedDate  \r\n        ,PPAttrib     \r\n        ,PComment     \r\n        ,PostType     \r\n        ,CreatedBy \r\n        ,CreatedOn  \r\n    --FROM dbo.Flag \r\n    FROM Flag \r\n    WHERE CustCd =  @CustCD\r\n\r\n       --SELECT * FROM @FlagInfo\r\n\r\nSELECT DISTINCT CUS.*\r\nINTO #CUSTempt \r\nFROM DatCustomer CUS\r\nINNER JOIN @FlagInfo FI ON CUS.CustCD =  FI.ContactCustCd -- 'TESTRAJ'\r\n       \r\n       --SELECT * FROM #CUSTempt\r\n\r\nSELECT DISTINCT ACC.*\r\nINTO #ACCTempt\r\nFROM Main.dbo.Account ACC \r\nINNER JOIN @FlagInfo FI ON ACC.CustCD =  FI.ContactCustCd -- 'TESTRAJ'\r\n\r\n       --SELECT * FROM #ACCTempt\r\n       \r\nSELECT\r\n\t\tF.ContactCustCd AS CustCD\r\n\t\t,IIF(AC.RegisteredName IS NULL, XMT_NAME, AC.RegisteredName) AS RegisteredName\r\n\t\t,Contact =\r\n             CASE\r\n                  WHEN AC.SubscriberType = 'Link-L'\r\n                     THEN \r\n\t\t\t\t\t\tISNULL(AC.ContactName, '')\r\n\t\t\t\t  ELSE \r\n\t\t\t\t\tIIF(ISNULL(u.FirstName + ' ' + u.LastName, '') = '', FIRST_NAME + ' ' + LAST_NAME, ISNULL(u.FirstName + ' ' + u.LastName, ''))\r\n\t\t\tEND\r\n\t\t--,IIF(ISNULL(u.FirstName + ' ' + u.LastName, '') = '', FIRST_NAME + ' ' + LAST_NAME, ISNULL(u.FirstName + ' ' + u.LastName, '')) AS Contact\r\n\t\t,IIF((ISNULL(AC.Phone,'') = '' OR ISNULL(AC.Phone,'') IS NULL), XMT_PHONE, ISNULL(AC.Phone,'')) AS Phone\r\n\t\t,IIF(ISNULL(AC.Fax,'') = '', COMPANY_FAX_PHONE, ISNULL(AC.Fax,'')) AS Fax\r\n\t\t,ISNULL(AC.HoursOfOperation, '') AS HoursOfOperation\r\n\t\t,IIF(ISNULL(AC.Email,'') = '', EMAIL_ADDRESS, ISNULL(AC.Email,'')) AS Email\r\n\t\t,U.ChatUserId \r\n\t\t,F.Id\r\n\t\t,F.CustCD\r\n\t\t,F.ContactCustCd\r\n\t\t, ROUND( 5 *RAND(convert(varbinary, newid())), 2) as Rating  --Temp: Generates Random rating \r\n\t\t,F.LToken\r\n\t\t,F.EToken\r\n\t\t,F.LPostedDate\r\n\t\t,F.LSrcCity     \r\n\t\t,F.LSrcSt       \r\n\t\t,F.LDestCity    \r\n\t\t,F.LDestSt      \r\n\t\t,F.LVSize       \r\n\t\t,F.LVType       \r\n\t\t,F.LPAttrib\r\n\t\t,F.LComment\r\n\t\t,F.PPostedDate  \r\n\t\t,F.PSrcCity     \r\n\t\t,F.PSrcSt       \r\n\t\t,F.PDestCity    \r\n\t\t,F.PDestSt      \r\n\t\t,F.PVSize       \r\n\t\t,F.PVType  \r\n\t\t,F.PPAttrib\r\n\t\t,F.PComment\r\n\t\t,F.PostType \r\n\t\t,AC.SubscriberType\r\n\r\nFROM\t@FlagInfo F\r\n        LEFT JOIN #ACCTempt AC\r\n            ON     F.ContactCustCD = AC.CustCD\r\n        LEFT JOIN #CUSTempt CUST\r\n            ON     F.ContactCustCd = CUST.CustCD  \r\n        LEFT JOIN Main.dbo.Contact C \r\n            ON AC.AccountId = C.AccountId and C.ContactType = 'Primary'  \r\n        LEFT JOIN Main.dbo.Users U   \r\n            ON c.UserId = u.UserId\r\n\r\nWHERE\tf.CustCD = @CustCD\r\n\r\n-- Cleanup\r\nDROP TABLE #CUSTempt ;\r\nDROP TABLE #ACCTempt;","parameters":[{"name":"CustCD","description":null,"mode":"IN","data_type":"varchar(10)","custom_fields":{}}],"dependencies":null,"imported_at":"2021-07-29 12:59"};