window.repositoryObject = {"parameters_custom_fields":[],"object_id":"p225","name":"usp_CreateSharedDocument","subtype":"PROCEDURE","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"LoadMatching@UDVLPLL4DATASRV.linklogi.com","id":"d9"}},{"field":"Schema","value":"dbo"},{"field":"Name","value":"usp_CreateSharedDocument"},{"field":"Type","value":"Procedure"}],"script":"CREATE PROCEDURE [dbo].[usp_CreateSharedDocument]\r\n    @DocumentId INT,\r\n\t@EToken INT,\r\n\t@IsSelected BIT = 0\r\nAS\r\n--------------------------------------------------------------------------\r\n-- PROCEDURE NAME :\tusp_CreateSharedDocument\r\n--------------------------------------------------------------------------\r\n-- DESCRIPTION    :\tCreate/update shared Broker Document records in “Document” table\r\n--\t\t\t\t\tDue to Memory Optimized tables restrictions, this SP gets executed\r\n--\t\t\t\t\tfrom another SP \"usp_CreateSharedDocument\" under LoadLinkWeb4 DB\r\n--\r\n-- INPUT PARAMS   :\t@@DocumentId: Carrier/Equipment record Document ID \r\n--\t\t\t\t\t@EToken: Equipment posting ID/Token\r\n--\t\t\t\t\t@IsSelected: selected for sharing flag (0/1)\r\n--\r\n-- OUTPUT PARAMS  :\tNone\r\n--\r\n--------------------------------------------------------------------------\r\n-- HISTORY :\r\n-- AUTHOR   DATE        DESCRIPTION\r\n-- Vevian   2019.02.25  LLSIM-2304: Initial Development\r\n--\t\t\t\t\t\tNew stored procedure to create shared Broker Document records in “Document” table\r\n-- Vevian\t2019.03.04\tLLSIM-2304: return Document info (DocumentId, DocumentName, EToken, IsSelected)\r\n-- Vevian\t2019.03.06\tLLSIM-2304: Broker Shared Document DocumentTypeId should not be the same as the Carrier DocumentTypeId\r\n--------------------------------------------------------------------------\r\nBEGIN\r\nSET NOCOUNT ON\r\n\r\n-- For step 1\r\nDECLARE @LUserId int = null, @LToken int = null\r\n-- For step 2\r\nDECLARE @DocumentTypeId int, @DocumentName varchar(255), @DocumentSize int, \r\n\t\t@Notes varchar(250), @CreatedBy int, @DocumentData varbinary(max),\r\n\t\t@FileType nvarchar(250), @ThumbnailData varbinary(max), @StatusId smallint\r\nDECLARE @AccountId int = null\r\n-- For step 3\r\nDECLARE @SharedDocumentId int, @CreateRes int = 0, @CreatedRowGUID varchar(50) = ''\r\n\r\n\r\nif exists (SELECT 1 FROM [Document].[dbo].[Document] WHERE\tDocumentId = @DocumentId)\r\nBEGIN\r\n\t-- step 1: get the Broker UserId and LToken based on @EToken\r\n\r\n\tSELECT\t@LUserId = l.CreatedBy, @LToken = a.Token \r\n\tFROM\t[dbo].[AssignedLoad] a\r\n\t\t\tINNER JOIN dbo.LoadPosting l on a.Token = l.Token\r\n\tWHERE\ta.EToken = @EToken and a.DeletedOn is null\r\n\r\n\r\n\t-- step 2: get carrier Document info based on @DocumentId & get AccountId based on @LUserId\r\n\r\n\tSELECT\t@DocumentName = [DocumentName], @DocumentSize = [DocumentSize], @Notes = [Notes], @CreatedBy = [CreatedBy],  \r\n\t\t\t@DocumentData = [DocumentData], @FileType = [FileType], @ThumbnailData = [ThumbnailData], @StatusId = [StatusId], \r\n\t\t\t@SharedDocumentId = ISNULL([SharedDocId], 0)\r\n\tFROM\t[Document].[dbo].[Document] \r\n\tWHERE\tDocumentId = @DocumentId\r\n\r\n\tSELECT @AccountId = AccountId FROM [Main].[dbo].[Users] WITH(NOLOCK) WHERE UserId = @LUserId\r\n\r\n\r\n\t-- step 3: \r\n\t--\t\tif SharedDocId returned from last step is 0, execute [usp_CreateDocument] stored procedure to create Broker shared Document record.\r\n\t--\t\tif SharedDocId returned from last step is not 0, Check the @IsSelected value; if 0 then soft delete the Shared document record \r\n\r\n\tif (@SharedDocumentId = 0 and @IsSelected <> 0)\r\n\t\tBEGIN\r\n\t\t\tif (@LUserId > 0 and @LToken > 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tSET @DocumentTypeId = 6\t\t-- Broker Document should have DocumentTypeId 6 not same as the carrier Document (8)\r\n\r\n\t\t\t\t\tEXEC [Document].[dbo].[usp_CreateDocument] \r\n\t\t\t\t\t\t\t@UserId = @LUserId,\r\n\t\t\t\t\t\t\t@AccountId = @AccountId,\r\n\t\t\t\t\t\t\t@DocumentTypeId = @DocumentTypeId,\r\n\t\t\t\t\t\t\t@DocumentName = @DocumentName,\r\n\t\t\t\t\t\t\t@DocumentSize = @DocumentSize,\r\n\t\t\t\t\t\t\t@Notes = @Notes,\r\n\t\t\t\t\t\t\t@CreatedBy = @CreatedBy,\r\n\t\t\t\t\t\t\t@DocumentData = @DocumentData,\r\n\t\t\t\t\t\t\t@FileType = @FileType,\r\n\t\t\t\t\t\t\t@EntityId = @LToken,\r\n\t\t\t\t\t\t\t@DocumentId = @SharedDocumentId OUTPUT,\r\n\t\t\t\t\t\t\t@res = @CreateRes OUTPUT,\r\n\t\t\t\t\t\t\t@Rowguid = @CreatedRowGUID OUTPUT\r\n\r\n\t\t\t\t\tif (@@ERROR = 0)\r\n\t\t\t\t\t\tBEGIN\t\t\r\n\t\t\t\t\t\t\t-- step 4: Update Carrier Doument record fields (IsSelected & SharedDocId) \r\n\r\n\t\t\t\t\t\t\tUPDATE\t[Document].[dbo].[Document] \r\n\t\t\t\t\t\t\tSET\t\tIsSelected = @IsSelected, SharedDocId = @SharedDocumentId\r\n\t\t\t\t\t\t\tWHERE\tDocumentId = @DocumentId\r\n\t\t\t\t\t\tEND\r\n\t\t\t\tEND\r\n\t\t\telse\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tprint 'Broker Posting record does not exist.'\r\n\t\t\t\tEND\r\n\t\tEND\r\n\telse\r\n\t\tBEGIN\r\n\t\t\tif (@IsSelected = 0)\r\n\t\t\t\tBEGIN\r\n\t\t\t\t\tif (@SharedDocumentId <> 0)\r\n\t\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\t\t-- mark Broker shared Document record as deleted (StatusId = -3)\r\n\t\t\t\t\t\t\tUPDATE\t[Document].[dbo].[Document] \r\n\t\t\t\t\t\t\tSET\t\tStatusId = -3\r\n\t\t\t\t\t\t\tWHERE\tDocumentId = @SharedDocumentId\r\n\r\n\t\t\t\t\t\t\tif (@@ERROR = 0)\r\n\t\t\t\t\t\t\t\tBEGIN\r\n\t\t\t\t\t\t\t\t\tUPDATE\t[Document].[dbo].[Document] \r\n\t\t\t\t\t\t\t\t\tSET\t\tIsSelected = @IsSelected, SharedDocId = null\r\n\t\t\t\t\t\t\t\t\tWHERE\tDocumentId = @DocumentId\r\n\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\tEND \r\n\t\t\t\tEND\r\n\t\tEND\r\nEND\r\nELSE\r\n\tBEGIN\r\n\t\tprint 'Carrier Document record does not exist.'\r\n\tEND\r\n\r\n\r\n-- Last Step: return the current document info\r\nSELECT\tDocumentId, DocumentName, EntityId AS EToken, IsSelected \r\nFROM\t[Document].[dbo].[Document] \r\nWHERE DocumentId = @DocumentId\r\n\r\n\r\nEND","parameters":[{"name":"DocumentId","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"EToken","description":null,"mode":"IN","data_type":"int","custom_fields":{}},{"name":"IsSelected","description":null,"mode":"IN","data_type":"bit","custom_fields":{}}],"dependencies":null,"imported_at":"2021-07-29 12:59"};